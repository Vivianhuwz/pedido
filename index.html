<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOUBAI - Sistema de Gerenciamento de Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Adicionar biblioteca SheetJS para processar arquivos Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Supabase客户端库 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- 配置文件 -->
  <script src="config.js"></script>
  
  <style>
    /* 客户侧边栏自定义样式 */
    #customerSidebar {
      transition: width 0.3s ease, opacity 0.3s ease;
      min-height: calc(100vh - 200px);
    }
    
    .customer-item {
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }
    
    .customer-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .customer-item.selected {
      background: linear-gradient(135deg, #EBF4FF 0%, #E1F0FF 100%);
      border-color: #3B82F6;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15);
    }
    
    /* 客户列表容器样式 */
    #customerList {
      padding: 8px;
    }
    
    /* 客户卡片内的数值样式 */
    .customer-item .bg-green-50 {
      background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
    }
    
    .customer-item .bg-blue-50 {
      background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    }
    
    /* 响应式设计 - 参考云收账系统优化 */
    
    /* 平板设备优化 (641px - 1366px) */
    @media (min-width: 641px) and (max-width: 1366px) {
      #customerSidebar {
        width: 280px !important;
        position: relative;
        display: block;
        opacity: 1;
        transform: translateX(0);
      }
      
      .main-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1.5rem;
      }
      
      /* 当客户侧边栏隐藏时，主要内容区域占用全部宽度 */
      #customerSidebar[style*="width: 0"],
      #customerSidebar[style*="opacity: 0"] {
        display: none !important;
      }
      
      #customerSidebar[style*="width: 0"] ~ #mainContent,
      #customerSidebar[style*="opacity: 0"] ~ #mainContent {
        grid-column: 1 / -1;
      }
      
      .main-layout:has(#customerSidebar[style*="width: 0"]),
      .main-layout:has(#customerSidebar[style*="opacity: 0"]) {
        grid-template-columns: 1fr;
      }
    }
    
    /* 桌面设备 (大于1366px) */
    @media (min-width: 1367px) {
      #customerSidebar {
        width: 320px !important;
        position: relative;
        display: block;
        opacity: 1;
        transform: translateX(0);
      }
      
      .main-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
      }
      
      /* 当客户侧边栏隐藏时，主要内容区域占用全部宽度 */
      #customerSidebar[style*="width: 0"],
      #customerSidebar[style*="opacity: 0"] {
        display: none !important;
      }
      
      #customerSidebar[style*="width: 0"] ~ #mainContent,
      #customerSidebar[style*="opacity: 0"] ~ #mainContent {
        grid-column: 1 / -1;
      }
      
      .main-layout:has(#customerSidebar[style*="width: 0"]),
      .main-layout:has(#customerSidebar[style*="opacity: 0"]) {
        grid-template-columns: 1fr;
      }
    }
    
    /* 手机设备 (最大宽度: 640px) */
    @media (max-width: 640px) {
      #customerSidebar {
        position: fixed;
        left: 0;
        top: 80px;
        height: calc(100vh - 80px);
        width: 280px !important;
        z-index: 40;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      
      #customerSidebar.hidden-mobile {
        transform: translateX(-100%);
      }
      
      .main-layout {
        display: block;
      }
      
      /* 移动端表格在客户侧边栏隐藏时自动扩展 */
      #mainContent {
        width: 100%;
        transition: all 0.3s ease;
      }
    }
    
    /* 触摸设备优化 */
    @media (hover: none) and (pointer: coarse) {
      .customer-item {
        min-height: 44px;
        padding: 12px;
      }
      
      .customer-item:hover {
        transform: none;
      }
    }
    
    /* 滚动条样式 */
    #customerList::-webkit-scrollbar {
      width: 4px;
    }
    
    #customerList::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    
    #customerList::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }
    
    #customerList::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* 客户侧边栏隐藏时的通用样式 */
    .sidebar-hidden .main-layout {
      grid-template-columns: 1fr !important;
    }
    
    .sidebar-hidden #customerSidebar {
      display: none !important;
    }
    
    .sidebar-hidden #mainContent {
      grid-column: 1 / -1;
      width: 100%;
      max-width: 100%;
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            'gray-50': '#F5F7FA',
            'gray-100': '#E5E6EB',
            'gray-200': '#C9CDD4',
            'gray-300': '#86909C',
            'gray-400': '#4E5969',
            'gray-500': '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  // Evitar perda de dados ao atualizar a página
  window.addEventListener('beforeunload', function(e) {
    // Se houver alterações não sincronizadas, alertar o usuário
    if (orders.length > 0 && document.getElementById('syncStatus') && 
        document.getElementById('syncStatus').querySelector('span').textContent !== 'Sincronizado') {
      e.preventDefault();
      e.returnValue = '';
    }
  });
  
  // 双击编辑功能
  let currentEditingCell = null;
  
  function editCell(cell) {
    // 如果已经有单元格在编辑中，先保存
    if (currentEditingCell && currentEditingCell !== cell) {
      saveCellEdit(currentEditingCell);
    }
    
    const field = cell.getAttribute('data-field');
    const orderId = parseInt(cell.getAttribute('data-order-id'));
    const order = orders.find(o => o.id === orderId);
    
    if (!order) return;
    
    // 获取当前值
    let currentValue = order[field] || '';
    
    // 对于特殊字段的处理
    if (field === 'finalValue') {
      currentValue = order[field] || 0;
    } else if (field === 'issueDate') {
      if (currentValue) {
        const date = new Date(currentValue);
        currentValue = date.toISOString().split('T')[0];
      }
    }
    
    // 创建输入框
    const input = document.createElement('input');
    input.className = 'cell-input';
    input.value = currentValue;
    
    // 根据字段类型设置输入框类型
    if (field === 'finalValue') {
      input.type = 'number';
      input.step = '0.01';
      input.min = '0';
    } else if (field === 'issueDate') {
      input.type = 'date';
    } else {
      input.type = 'text';
    }
    
    // 保存原始内容
    cell.setAttribute('data-original-content', cell.innerHTML);
    
    // 替换单元格内容
    cell.innerHTML = '';
    cell.appendChild(input);
    cell.classList.add('editing-cell');
    
    // 聚焦并选中文本
    input.focus();
    if (input.type === 'text') {
      input.select();
    }
    
    currentEditingCell = cell;
    
    // 添加事件监听器
    input.addEventListener('blur', () => saveCellEdit(cell));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        saveCellEdit(cell);
      } else if (e.key === 'Escape') {
        cancelCellEdit(cell);
      }
    });
  }
  
  function saveCellEdit(cell) {
    if (!cell || !cell.classList.contains('editing-cell')) return;
    
    const input = cell.querySelector('.cell-input');
    if (!input) return;
    
    const field = cell.getAttribute('data-field');
    const orderId = parseInt(cell.getAttribute('data-order-id'));
    const order = orders.find(o => o.id === orderId);
    
    if (!order) {
      cancelCellEdit(cell);
      return;
    }
    
    let newValue = input.value.trim();
    
    // 验证和转换值
    if (field === 'finalValue') {
      newValue = parseFloat(newValue) || 0;
    } else if (field === 'issueDate') {
      if (newValue && !isNaN(new Date(newValue).getTime())) {
        newValue = new Date(newValue).toISOString();
      } else {
        newValue = order[field]; // 保持原值
      }
    }
    
    // 更新订单数据
    order[field] = newValue;
    
    // 如果NF字段有数据，自动将Status改为Concluído
    if (field === 'nf' && newValue && newValue.trim() !== '') {
        order.status = 'Concluído';
        showNotification('NF atualizado e status alterado para Concluído!', 'success');
    } else {
        showNotification('Campo atualizado com sucesso!', 'success');
    }
    
    // 保存到本地存储
    saveToLocalStorage();
    
    // 重新应用过滤器和更新显示
    applyFilters();
    
    currentEditingCell = null;
  }
  
  function cancelCellEdit(cell) {
    if (!cell || !cell.classList.contains('editing-cell')) return;
    
    const originalContent = cell.getAttribute('data-original-content');
    cell.innerHTML = originalContent;
    cell.classList.remove('editing-cell');
    cell.removeAttribute('data-original-content');
    
    currentEditingCell = null;
  }
  
  // 点击其他地方时保存编辑
  document.addEventListener('click', (e) => {
    if (currentEditingCell && !currentEditingCell.contains(e.target) && !e.target.classList.contains('cell-input')) {
      saveCellEdit(currentEditingCell);
    }
  });
  </script>
  <style>
    .status-option {
      transition: background-color 0.2s;
    }
    .status-option:hover {
      background-color: #f3f4f6;
    }
    /* 添加统计板卡片的悬停效果 */
    .stat-card {
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    /* 复选框样式 */
    .form-checkbox {
        appearance: none;
        -webkit-appearance: none;
        border: 1px solid #cbd5e0;
        border-radius: 0.25rem;
        display: inline-block;
        position: relative;
        vertical-align: middle;
        background-color: #fff;
        color: #4299e1;
        cursor: pointer;
    }
    
    .form-checkbox:checked {
        background-color: currentColor;
        border-color: currentColor;
    }
    
    .form-checkbox:checked::after {
        content: '';
        display: block;
        position: absolute;
        top: 0.1rem;
        left: 0.3rem;
        width: 0.3rem;
        height: 0.6rem;
        border: solid white;
        border-width: 0 0.15rem 0.15rem 0;
        transform: rotate(45deg);
    }

    /* 移动端导航样式 */
    .mobile-nav-item {
      transition: all 0.3s ease;
    }
    
    .mobile-nav-item.active {
      background: #3b82f6 !important;
      color: white !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .mobile-nav-item:hover:not(.active) {
      background-color: #ffffff;
      transform: translateY(-1px);
    }

    /* 汉堡菜单动画 */
    .hamburger-line {
      transition: all 0.3s ease;
    }
    
    .hamburger-open .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .hamburger-open .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-open .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }

    /* Logo样式和动画 */
    .company-logo {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .company-logo:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 8px 25px rgba(22, 93, 255, 0.3);
    }
    
    .company-logo svg {
      transition: all 0.3s ease;
    }
    
    .company-logo:hover svg {
      transform: scale(1.1);
    }

    /* 移动端搜索框动画 */
    #mobileSearchContainer {
      transition: all 0.3s ease;
      transform: translateY(-10px);
      opacity: 0;
    }
    
    #mobileSearchContainer.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    #mobileSearchBtn {
      transition: all 0.2s ease;
    }
    
    #mobileSearchBtn:hover {
      background-color: rgba(135, 206, 235, 0.2);
    }
    
    #mobileSearchBtn.active {
      background-color: rgba(135, 206, 235, 0.3);
      color: #2563eb;
    }

    /* 可编辑单元格样式 */
    .editable-cell {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .editable-cell:hover {
      background-color: #f8fafc;
    }
    
    .editing-cell {
      background-color: #e0f2fe !important;
      padding: 0 !important;
    }
    
    .cell-input {
      width: 100%;
      height: 100%;
      border: 2px solid #2563eb;
      padding: 8px;
      font-size: inherit;
      font-family: inherit;
      background: white;
      outline: none;
    }
    
    .cell-input:focus {
      border-color: #1d4ed8;
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
      .mobile-nav-scroll {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      .mobile-nav-scroll::-webkit-scrollbar {
        display: none;
      }
      
      .stat-card:hover {
        transform: none;
      }
      
      .company-logo:hover {
        transform: scale(1.02);
      }
      
      .editable-cell:hover {
        background-color: transparent;
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-gray-500 min-h-screen">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <!-- Logo和标题区域 -->
    <div class="px-4 sm:px-6 lg:px-8">
      <div class="flex items-center h-16 px-4">
        <!-- 移动端：左侧区域 -->
        <div class="md:hidden flex items-center space-x-2">
          <!-- 汉堡菜单 -->
          <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" onclick="toggleMobileMenu()">
            <div class="w-6 h-6 flex flex-col justify-center items-center">
              <div class="hamburger-line w-5 h-0.5 bg-gray-500 mb-1"></div>
              <div class="hamburger-line w-5 h-0.5 bg-gray-500 mb-1"></div>
              <div class="hamburger-line w-5 h-0.5 bg-gray-500"></div>
            </div>
          </button>
          
          <!-- YOUBAI标识 -->
          <h1 class="text-lg font-semibold text-gray-500">YOUBAI</h1>
          
          <!-- 搜索按钮 -->
          <button id="mobileSearchBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" onclick="toggleMobileSearch()">
            <i class="fa fa-search text-gray-500 text-lg"></i>
          </button>
        </div>
        
        <!-- 桌面版Logo和标题 -->
        <div class="hidden md:block">
          <h1 class="text-lg font-semibold text-gray-500">YOUBAI</h1>
          <p class="text-xs text-gray-300">Sistema de Gerenciamento de Pedidos</p>
        </div>
        
        <!-- 搜索框 - 桌面版 -->
        <div class="hidden md:flex flex-1 justify-center mx-8">
          <div class="relative w-80">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa fa-search text-gray-300"></i>
            </div>
            <input type="text" id="headerSearchInput" placeholder="Pesquisar pedidos..." 
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
              oninput="searchOrders()">
          </div>
        </div>
        
        <!-- 右侧区域：同步图标将在这里显示 -->
        <div class="flex-1 flex justify-end" id="headerRight">
          <!-- 桌面版和移动端的同步图标都会动态添加到这里 -->
        </div>
      </div>
    </div>
    
    <!-- 移动端搜索框 -->
    <div id="mobileSearchContainer" class="md:hidden px-4 pb-4 hidden">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fa fa-search text-gray-300"></i>
        </div>
        <input type="text" id="mobileSearchInput" placeholder="Pesquisar pedidos..." 
          class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
          oninput="searchOrders()">
        <button class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="toggleMobileSearch()">
          <i class="fa fa-times text-gray-400 hover:text-gray-600"></i>
        </button>
      </div>
    </div>
    
    <!-- 导航菜单 - 桌面版 -->
    <nav class="hidden md:block border-t border-gray-100">
      <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex space-x-1 py-3 overflow-x-auto mobile-nav-scroll">
          <a href="#" onclick="filterByStatus('all')" id="nav-all" class="mobile-nav-item active flex items-center px-4 py-2 text-sm font-medium rounded-lg whitespace-nowrap">
            <i class="fa fa-list mr-2"></i>
            <span>Todos</span>
            <span class="ml-2 bg-white bg-opacity-20 text-xs px-2 py-1 rounded-full" id="count-all">0</span>
          </a>
          <a href="#" onclick="filterByStatus('pending')" id="nav-pending" class="mobile-nav-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg whitespace-nowrap">
            <i class="fa fa-clock-o mr-2 text-orange-500"></i>
            <span>Aguardando</span>
            <span class="ml-2 bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full" id="count-pending">0</span>
          </a>
          <a href="#" onclick="filterByStatus('processing')" id="nav-processing" class="mobile-nav-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg whitespace-nowrap">
            <i class="fa fa-spinner mr-2 text-blue-500"></i>
            <span>Processando</span>
            <span class="ml-2 bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full" id="count-processing">0</span>
          </a>
          <a href="#" onclick="filterByStatus('completed')" id="nav-completed" class="mobile-nav-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg whitespace-nowrap">
            <i class="fa fa-check-circle mr-2 text-green-500"></i>
            <span>Concluído</span>
            <span class="ml-2 bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full" id="count-completed">0</span>
          </a>
          <a href="#" onclick="filterByStatus('cancelled')" id="nav-cancelled" class="mobile-nav-item flex items-center px-4 py-2 text-sm font-medium text-gray-600 rounded-lg whitespace-nowrap">
            <i class="fa fa-times-circle mr-2 text-red-500"></i>
            <span>Cancelado</span>
            <span class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full" id="count-cancelled">0</span>
          </a>
        </div>
      </div>
    </nav>
    
    <!-- 移动端导航菜单 -->
    <nav id="mobileNav" class="md:hidden hidden border-t border-gray-100 bg-white">
      <div class="px-4 py-3 space-y-2">
        <a href="#" onclick="filterByStatus('all'); closeMobileMenu()" id="nav-all-mobile" class="mobile-nav-item active flex items-center px-4 py-3 text-sm font-medium rounded-lg">
          <i class="fa fa-list mr-3"></i>
          <span>Todos os Pedidos</span>
          <span class="ml-auto bg-white bg-opacity-20 text-xs px-2 py-1 rounded-full" id="count-all-mobile">0</span>
        </a>
        <a href="#" onclick="filterByStatus('pending'); closeMobileMenu()" id="nav-pending-mobile" class="mobile-nav-item flex items-center px-4 py-3 text-sm font-medium text-gray-600 rounded-lg">
          <i class="fa fa-clock-o mr-3 text-orange-500"></i>
          <span>Aguardando</span>
          <span class="ml-auto bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full" id="count-pending-mobile">0</span>
        </a>
        <a href="#" onclick="filterByStatus('processing'); closeMobileMenu()" id="nav-processing-mobile" class="mobile-nav-item flex items-center px-4 py-3 text-sm font-medium text-gray-600 rounded-lg">
          <i class="fa fa-spinner mr-3 text-blue-500"></i>
          <span>Processando</span>
          <span class="ml-auto bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full" id="count-processing-mobile">0</span>
        </a>
        <a href="#" onclick="filterByStatus('completed'); closeMobileMenu()" id="nav-completed-mobile" class="mobile-nav-item flex items-center px-4 py-3 text-sm font-medium text-gray-600 rounded-lg">
          <i class="fa fa-check-circle mr-3 text-green-500"></i>
          <span>Concluído</span>
          <span class="ml-auto bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full" id="count-completed-mobile">0</span>
        </a>
        <a href="#" onclick="filterByStatus('cancelled'); closeMobileMenu()" id="nav-cancelled-mobile" class="mobile-nav-item flex items-center px-4 py-3 text-sm font-medium text-gray-600 rounded-lg">
          <i class="fa fa-times-circle mr-3 text-red-500"></i>
          <span>Cancelado</span>
          <span class="ml-auto bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full" id="count-cancelled-mobile">0</span>
        </a>
      </div>
    </nav>
  </header>

  <!-- 主要内容区域 -->
  <main class="flex-1 px-4 sm:px-6 lg:px-8 py-6">
    <div class="main-layout">
      <!-- 客户管理侧边栏 -->
      <div id="customerSidebar" class="w-80 bg-white rounded-xl shadow-sm overflow-hidden transition-all duration-300">
        <div class="p-4 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-700">
              <i class="fa fa-users mr-2 text-blue-600"></i>
              Clientes
            </h3>
            <button onclick="toggleCustomerSidebar()" class="p-1 hover:bg-gray-100 rounded transition-colors">
              <i class="fa fa-times text-gray-400"></i>
            </button>
          </div>
          <div class="mt-3">
            <input type="text" id="customerSearch" placeholder="Digite nome, contato ou..." 
                   class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   oninput="filterCustomers()">
          </div>
        </div>
        <div class="overflow-y-auto" style="max-height: calc(100vh - 200px);">
          <div id="customerList" class="p-4 space-y-2">
            <!-- 客户列表将在这里动态生成 -->
          </div>
        </div>
      </div>

      <!-- 主要内容区域 -->
      <div id="mainContent" class="flex-1 transition-all duration-300">
      <!-- Painel de estatísticas -->
      <div class="grid grid-cols-2 lg:grid-cols-5 gap-2 sm:gap-4 mb-6 sm:mb-8">
        <!-- Total de pedidos -->
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-6 stat-card">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="text-xs sm:text-sm font-medium text-gray-400 mb-1 truncate">Total de Pedidos</p>
              <p class="text-lg sm:text-2xl font-bold text-gray-500" id="totalOrders">0</p>
              <p class="text-xs text-green-500 mt-1 hidden sm:block">
                <i class="fa fa-arrow-up"></i>
                <span id="totalOrdersGrowth">0%</span> em relação ao mês anterior
              </p>
            </div>
            <div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full flex items-center justify-center ml-2">
              <i class="fa fa-file-text-o text-sm sm:text-xl text-blue-600"></i>
            </div>
          </div>
        </div>

        <!-- Pedidos pendentes -->
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-6 stat-card">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="text-xs sm:text-sm font-medium text-gray-400 mb-1 truncate">Pedidos Pendentes</p>
              <p class="text-lg sm:text-2xl font-bold text-gray-500" id="pendingOrders">0</p>
              <p class="text-xs text-orange-500 mt-1 hidden sm:block">
                <i class="fa fa-arrow-up"></i>
                <span id="pendingOrdersGrowth">0%</span> em relação ao mês anterior
              </p>
            </div>
            <div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full flex items-center justify-center ml-2">
              <i class="fa fa-clock-o text-sm sm:text-xl text-orange-600"></i>
            </div>
          </div>
        </div>

        <!-- Pedidos concluídos -->
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-6 stat-card">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="text-xs sm:text-sm font-medium text-gray-400 mb-1 truncate">Pedidos Concluídos</p>
              <p class="text-lg sm:text-2xl font-bold text-gray-500" id="completedOrders">0</p>
              <p class="text-xs text-green-500 mt-1 hidden sm:block">
                <i class="fa fa-arrow-up"></i>
                <span id="completedOrdersGrowth">0%</span> em relação ao mês anterior
              </p>
            </div>
            <div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full flex items-center justify-center ml-2">
              <i class="fa fa-check-circle text-sm sm:text-xl text-green-600"></i>
            </div>
          </div>
        </div>

        <!-- Valor total dos pedidos -->
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-6 stat-card">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="text-xs sm:text-sm font-medium text-gray-400 mb-1 truncate">Valor Total dos Pedidos</p>
              <p class="text-lg sm:text-2xl font-bold text-gray-500" id="totalRevenue">¥0</p>
              <p class="text-xs text-green-500 mt-1 hidden sm:block">
                <i class="fa fa-arrow-up"></i>
                <span id="revenueGrowth">0%</span> em relação ao mês anterior
              </p>
            </div>
            <div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full flex items-center justify-center ml-2">
              <i class="fa fa-money text-sm sm:text-xl text-blue-600"></i>
            </div>
          </div>
        </div>

        <!-- Clientes por Status -->
        <div class="bg-white rounded-xl shadow-sm p-3 sm:p-6 stat-card">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="text-xs sm:text-sm font-medium text-gray-400 mb-1 truncate" id="customerStatusLabel">Todos os Clientes</p>
              <p class="text-lg sm:text-2xl font-bold" id="customerCount" style="color: #6b7280;">0</p>

            </div>
            <div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full flex items-center justify-center ml-2" id="customerStatusIcon">
              <i class="fa fa-users text-sm sm:text-xl text-purple-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de pedidos -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
        <div class="p-4 sm:p-6 border-b border-gray-100">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-500">Lista de Pedidos</h2>
            <!-- 按钮区域 -->
            <div class="flex flex-wrap gap-2 sm:space-x-3 sm:gap-0">
              <button id="customerSidebarToggle" onclick="toggleCustomerSidebar()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors text-sm">
                <i class="fa fa-users mr-1 sm:mr-2"></i><span class="hidden sm:inline">Clientes</span><span class="sm:hidden">Clientes</span>
              </button>
              <button onclick="showImportModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-50 transition-colors text-sm">
                <i class="fa fa-upload mr-1 sm:mr-2"></i><span class="hidden sm:inline">Importar Dados</span><span class="sm:hidden">Importar</span>
              </button>
              <button id="batchOperationsBtn" onclick="showBatchOperationsModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition-colors text-sm" disabled>
                <i class="fa fa-tasks mr-1 sm:mr-2"></i><span class="hidden sm:inline">Operações em Lote</span><span class="sm:hidden">Lote</span>
              </button>
              <button onclick="printOrderList()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                <i class="fa fa-print mr-1 sm:mr-2"></i><span class="hidden sm:inline">Imprimir</span><span class="sm:hidden">Imprimir</span>
              </button>
              <button onclick="toggleColumnVisibilityModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-orange-100 text-orange-600 rounded-lg hover:bg-orange-50 transition-colors text-sm">
                <i class="fa fa-eye mr-1 sm:mr-2"></i><span class="hidden sm:inline">Colunas</span><span class="sm:hidden">Colunas</span>
              </button>
              <button onclick="showAddOrderModal()" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm">
                <i class="fa fa-plus mr-1 sm:mr-2"></i><span class="hidden sm:inline">Pedido</span><span class="sm:hidden">Novo</span>
              </button>
            </div>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-100">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-center">
                  <input type="checkbox" id="selectAllOrders" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out" onchange="toggleAllOrders(this.checked)">
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase" data-column="numero">Nº</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase" data-column="nf">NF</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase" data-column="pedido">Pedido</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase relative" data-column="cliente">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center cursor-pointer hover:bg-gray-100 transition-colors px-2 py-1 rounded" onclick="sortByColumn('client')" data-sort-column="client">
                      <span>Cliente</span>
                    </div>
                    <div class="cursor-pointer hover:bg-gray-100 transition-colors p-1 rounded" onclick="toggleColumnFilter('client')">
                      <svg class="w-4 h-4 text-gray-400 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                  <div id="filter-client" class="absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3">
                      <div class="space-y-2 max-h-48 overflow-y-auto" id="filter-options-client">
                        <!-- 筛选选项将动态生成 -->
                      </div>
                    </div>
                  </div>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase relative" data-column="data">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center cursor-pointer hover:bg-gray-100 transition-colors px-2 py-1 rounded" onclick="sortByColumn('issueDate')" data-sort-column="issueDate">
                      <span>DATA</span>
                    </div>
                    <div class="cursor-pointer hover:bg-gray-100 transition-colors p-1 rounded" onclick="toggleColumnFilter('issueDate')">
                      <svg class="w-4 h-4 text-gray-400 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </div>
                  </div>
                  <div id="filter-issueDate" class="absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3">
                      <div class="space-y-2 max-h-48 overflow-y-auto" id="filter-options-issueDate">
                        <!-- 筛选选项将动态生成 -->
                      </div>
                    </div>
                  </div>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase" data-column="valor">Valor Final</th>

                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase" data-column="tipo">TIPO</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase relative" data-column="representante">
                  <div class="flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleColumnFilter('representative')">
                    <span>Representante</span>
                    <svg class="w-4 h-4 text-gray-400 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                  <div id="filter-representative" class="absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3">
                      <div class="space-y-2 max-h-48 overflow-y-auto" id="filter-options-representative">
                        <!-- 筛选选项将动态生成 -->
                      </div>
                    </div>
                  </div>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase relative" data-column="status">
                  <div class="flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleColumnFilter('status')">
                    <span>Status</span>
                    <svg class="w-4 h-4 text-gray-400 transition-all duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                  <div id="filter-status" class="absolute top-full left-0 mt-1 w-64 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                    <div class="p-3">
                      <div class="space-y-2 max-h-48 overflow-y-auto" id="filter-options-status">
                        <!-- 筛选选项将动态生成 -->
                      </div>
                    </div>
                  </div>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase hidden md:table-cell" data-column="tabpreco">Tab. Preço</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase hidden md:table-cell" data-column="acerto">% Acerto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase hidden md:table-cell" data-column="cx">CX</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase hidden md:table-cell" data-column="operador">Operador</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase" data-column="acoes">Ações</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="orderTableBody">
              <!-- Os dados dos pedidos serão inseridos dinamicamente via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      </div> <!-- 结束 mainContent -->
    </div> <!-- 结束 flex 容器 -->
  </main>
  </div>

  <script>
    // Constantes para armazenamento e API
    const STORAGE_KEY = 'order_management_system_data';
    const API_BASE_URL = 'https://api.example.com'; // Substitua pela URL real da sua API
    
    // 选中的订单ID数组
    let selectedOrderIds = [];
    
    // 列筛选状态
    let columnFilters = {
      client: [],
      issueDate: [],
      representative: [],
      status: []
    };
    
    let currentOpenFilter = null;
    
    // 排序状态
    let sortState = {
      column: null,
      direction: 'asc' // 'asc' 或 'desc'
    };
    
    // 切换列筛选下拉菜单
    function toggleColumnFilter(column) {
      const filterId = `filter-${column}`;
      const filterElement = document.getElementById(filterId);
      
      // 关闭其他打开的筛选菜单
      if (currentOpenFilter && currentOpenFilter !== filterId) {
        document.getElementById(currentOpenFilter).classList.add('hidden');
      }
      
      if (filterElement.classList.contains('hidden')) {
        // 生成筛选选项
        generateFilterOptions(column);
        filterElement.classList.remove('hidden');
        currentOpenFilter = filterId;
      } else {
        filterElement.classList.add('hidden');
        currentOpenFilter = null;
      }
    }
    
    // 生成筛选选项
    function generateFilterOptions(column) {
      const optionsContainer = document.getElementById(`filter-options-${column}`);
      
      // 获取该列的所有唯一值
      let uniqueValues = [];
      if (column === 'client') {
        // 对于客户列，获取原始公司名称并格式化显示（只显示"-"后面的内容）
        const rawCompanies = [...new Set(orders.map(order => order.company))].sort();
        uniqueValues = rawCompanies.map(company => ({
          raw: company,
          display: formatCompanyNameForFilter(company)
        }));
      } else if (column === 'issueDate') {
        // 对于日期列，获取原始日期值并格式化为DD/MM/YYYY显示
        const rawDates = [...new Set(orders.map(order => order.issueDate))].sort();
        uniqueValues = rawDates.map(date => ({
          raw: date,
          display: formatDateForFilter(date)
        }));
      } else if (column === 'representative') {
        uniqueValues = [...new Set(orders.map(order => order.representative))].filter(rep => rep && rep.trim() !== '').sort();
      } else if (column === 'status') {
        uniqueValues = [...new Set(orders.map(order => order.status))].sort();
      }
      
      // 生成HTML
      let html = `
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-medium text-gray-700">Filtrar por:</span>
          <button onclick="clearColumnFilter('${column}')" class="text-xs text-blue-600 hover:text-blue-800">Limpar</button>
        </div>
        <label class="flex items-center space-x-2 mb-2 cursor-pointer">
          <input type="checkbox" ${columnFilters[column].length === uniqueValues.length && uniqueValues.length > 0 ? 'checked' : ''} onchange="selectAllFilterOptions(&quot;${column}&quot;, this.checked)" class="form-checkbox h-4 w-4 text-blue-600">
          <span class="text-sm text-gray-700 font-medium">Todos</span>
        </label>
        <hr class="mb-2">
      `;
      
      uniqueValues.forEach(value => {
        let displayValue, rawValue;
        if ((column === 'issueDate' || column === 'client') && typeof value === 'object') {
          displayValue = value.display;
          rawValue = value.raw;
        } else {
          displayValue = value;
          rawValue = value;
        }
        
        const isChecked = columnFilters[column].length > 0 && columnFilters[column].includes(rawValue);
        html += `
          <label class="flex items-center space-x-2 mb-1 cursor-pointer hover:bg-gray-50 p-1 rounded">
            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleFilterOption(&quot;${column}&quot;, &quot;${rawValue.replace(/"/g, '&quot;')}&quot;, this.checked)" class="form-checkbox h-4 w-4 text-blue-600">
            <span class="text-sm text-gray-600">${displayValue}</span>
          </label>
        `;
      });
      
      optionsContainer.innerHTML = html;
    }
    
    // 切换筛选选项
    function toggleFilterOption(column, value, checked) {
      if (checked) {
        if (!columnFilters[column].includes(value)) {
          columnFilters[column].push(value);
        }
      } else {
        columnFilters[column] = columnFilters[column].filter(v => v !== value);
      }
      
      // 更新全选复选框状态
      let allValues = [];
      if (column === 'client') {
        allValues = [...new Set(orders.map(order => order.company))];
      } else if (column === 'issueDate') {
        allValues = [...new Set(orders.map(order => order.issueDate))];
      } else if (column === 'representative') {
        allValues = [...new Set(orders.map(order => order.representative))];
      } else if (column === 'status') {
        allValues = [...new Set(orders.map(order => order.status))];
      }
      
      const selectAllCheckbox = document.querySelector(`#filter-options-${column} input[type="checkbox"]:first-child`);
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = columnFilters[column].length === allValues.length && allValues.length > 0;
      }
      
      applyColumnFilters();
      updateFilterArrows();
    }
    
    // 全选/取消全选筛选选项
    function selectAllFilterOptions(column, checked) {
      if (checked) {
        // 全选：获取所有选项并设置筛选
        let allValues = [];
        if (column === 'client') {
          allValues = [...new Set(orders.map(order => order.company))];
        } else if (column === 'issueDate') {
          allValues = [...new Set(orders.map(order => order.issueDate))];
        } else if (column === 'representative') {
          allValues = [...new Set(orders.map(order => order.representative))];
        } else if (column === 'status') {
          allValues = [...new Set(orders.map(order => order.status))];
        }
        columnFilters[column] = [...allValues];
      } else {
        // 取消全选：清空筛选（显示所有项目）
        columnFilters[column] = [];
      }
      
      // 更新所有复选框状态
      const checkboxes = document.querySelectorAll(`#filter-options-${column} input[type="checkbox"]:not(:first-child)`);
      checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
      });
      
      applyColumnFilters();
      updateFilterArrows();
    }
    
    // 清除列筛选
    function clearColumnFilter(column) {
      columnFilters[column] = [];
      generateFilterOptions(column);
      applyColumnFilters();
      updateFilterArrows();
    }
    
    // 应用列筛选
    function applyColumnFilters() {
      let filtered = orders;
      
      // 应用状态筛选（导航筛选）
      if (currentStatusFilter && currentStatusFilter !== 'all') {
        filtered = filtered.filter(order => {
          const status = order.status.toLowerCase();
          switch (currentStatusFilter) {
            case 'pending':
              return ['aguardando', 'pendente'].includes(status);
            case 'processing':
              return ['processando', 'em andamento'].includes(status);
            case 'completed':
              return ['concluído', 'finalizado'].includes(status);
            case 'cancelled':
              return status === 'cancelado';
            default:
              return true;
          }
        });
      }
      
      // 应用各列筛选
      Object.keys(columnFilters).forEach(column => {
        if (columnFilters[column].length > 0) {
          filtered = filtered.filter(order => {
            let value;
            if (column === 'client') {
              value = order.company;
            } else if (column === 'issueDate') {
              value = order.issueDate;
            } else if (column === 'representative') {
              value = order.representative;
            } else if (column === 'status') {
              value = order.status;
            }
            return columnFilters[column].includes(value);
          });
        }
      });
      
      // 应用搜索筛选
      const searchTerm = document.getElementById('headerSearchInput')?.value?.toLowerCase() || 
                        document.getElementById('mobileSearchInput')?.value?.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(order => {
          return (
            (order.nf && order.nf.toLowerCase().includes(searchTerm)) ||
            (order.pedido && order.pedido.toString().toLowerCase().includes(searchTerm)) ||
            (order.company && order.company.toLowerCase().includes(searchTerm)) ||
            (order.representative && order.representative.toLowerCase().includes(searchTerm)) ||
            (order.operator && order.operator.toLowerCase().includes(searchTerm)) ||
            (order.orderTypeDescription && order.orderTypeDescription.toLowerCase().includes(searchTerm)) ||
            (order.id && order.id.toString().includes(searchTerm))
          );
        });
      }
      
      filteredOrders = filtered;
      
      // 应用排序（如果有活动的排序）
      if (sortState.column) {
        applySorting();
      } else {
        renderFilteredOrders();
      }
      
      updateFilteredStatistics();
      updateSidebarCounts();
    }
    
    // 更新筛选箭头显示
    function updateFilterArrows() {
      Object.keys(columnFilters).forEach(column => {
        const arrow = document.querySelector(`[onclick="toggleColumnFilter('${column}')"] svg`);
        if (arrow) {
          if (columnFilters[column].length > 0) {
            arrow.classList.remove('text-gray-400');
            arrow.classList.add('text-blue-500');
          } else {
            arrow.classList.remove('text-blue-500');
            arrow.classList.add('text-gray-400');
          }
        }
      });
    }
    
    // 排序函数
    function sortByColumn(column) {
      // 如果点击的是同一列，切换排序方向
      if (sortState.column === column) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        // 如果是新列，设置为升序
        sortState.column = column;
        sortState.direction = 'asc';
      }
      
      // 应用排序
      applySorting();
      updateSortArrows();
    }
    
    // 应用排序
     function applySorting() {
       if (!sortState.column) return;
       
       filteredOrders.sort((a, b) => {
         let valueA, valueB;
         
         if (sortState.column === 'issueDate') {
           // 日期排序 - 处理日期字符串
           valueA = a.issueDate ? new Date(a.issueDate) : new Date(0);
           valueB = b.issueDate ? new Date(b.issueDate) : new Date(0);
         } else if (sortState.column === 'client') {
           // 客户名称排序 - 字符串排序
           valueA = (a.company || '').toLowerCase();
           valueB = (b.company || '').toLowerCase();
           
           if (sortState.direction === 'asc') {
             return valueA.localeCompare(valueB);
           } else {
             return valueB.localeCompare(valueA);
           }
         } else {
           // 其他列的排序逻辑可以在这里添加
           return 0;
         }
         
         if (sortState.direction === 'asc') {
           return valueA - valueB;
         } else {
           return valueB - valueA;
         }
       });
       
       renderFilteredOrders();
     }
    
    // 更新排序箭头显示
    function updateSortArrows() {
      // 清除所有排序箭头
      document.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.remove();
      });
      
      // 如果有活动的排序列，添加排序箭头
      if (sortState.column) {
        const headerElement = document.querySelector(`[data-sort-column="${sortState.column}"]`);
        if (headerElement) {
          const arrow = document.createElement('i');
          arrow.className = `fa ${sortState.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down'} sort-arrow ml-1 text-blue-500`;
          headerElement.appendChild(arrow);
        }
      }
    }
    
    // 移动端菜单功能
    function toggleMobileMenu() {
      const mobileNav = document.getElementById('mobileNav');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      
      if (mobileNav.classList.contains('hidden')) {
        mobileNav.classList.remove('hidden');
        mobileMenuBtn.classList.add('hamburger-open');
      } else {
        mobileNav.classList.add('hidden');
        mobileMenuBtn.classList.remove('hamburger-open');
      }
    }
    
    function closeMobileMenu() {
      const mobileNav = document.getElementById('mobileNav');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      
      mobileNav.classList.add('hidden');
      mobileMenuBtn.classList.remove('hamburger-open');
    }
    
    // 移动端搜索功能
    function toggleMobileSearch() {
      const searchContainer = document.getElementById('mobileSearchContainer');
      const searchInput = document.getElementById('mobileSearchInput');
      const searchBtn = document.getElementById('mobileSearchBtn');
      
      if (searchContainer.classList.contains('hidden')) {
        // 显示搜索框
        searchContainer.classList.remove('hidden');
        searchBtn.classList.add('active');
        
        // 添加动画类并聚焦
        setTimeout(() => {
          searchContainer.classList.add('show');
          searchInput.focus();
        }, 10);
      } else {
        // 隐藏搜索框
        searchContainer.classList.remove('show');
        searchBtn.classList.remove('active');
        
        // 等待动画完成后隐藏元素
        setTimeout(() => {
          searchContainer.classList.add('hidden');
          searchInput.value = '';
          // 清除搜索结果
          searchOrders();
        }, 300);
      }
    }
    
    // 点击外部关闭移动端菜单、搜索框和筛选菜单
    document.addEventListener('click', function(event) {
      const mobileNav = document.getElementById('mobileNav');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileSearchContainer = document.getElementById('mobileSearchContainer');
      const mobileSearchBtn = document.getElementById('mobileSearchBtn');
      
      // 关闭移动端菜单
      if (mobileNav && !mobileNav.classList.contains('hidden') && 
          !mobileNav.contains(event.target) && 
          !mobileMenuBtn.contains(event.target)) {
        closeMobileMenu();
      }
      
      // 关闭移动端搜索框
      if (mobileSearchContainer && !mobileSearchContainer.classList.contains('hidden') && 
          !mobileSearchContainer.contains(event.target) && 
          !mobileSearchBtn.contains(event.target)) {
        toggleMobileSearch();
      }
      
      // 关闭筛选菜单
      if (currentOpenFilter) {
        const filterElement = document.getElementById(currentOpenFilter);
        const clickedInsideFilter = filterElement && filterElement.contains(event.target);
        const clickedOnFilterButton = event.target.closest('[onclick*="toggleColumnFilter"]');
        
        if (!clickedInsideFilter && !clickedOnFilterButton) {
          filterElement.classList.add('hidden');
          currentOpenFilter = null;
        }
      }
    });
    
    // 全选/取消全选订单
    function toggleAllOrders(checked) {
      document.querySelectorAll('.order-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
      });
      updateBatchOperationsButton();
    }
    
    // 更新批量操作按钮状态
    function updateBatchOperationsButton() {
      selectedOrderIds = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(checkbox => 
        parseInt(checkbox.getAttribute('data-order-id'))
      );
      
      const batchBtn = document.getElementById('batchOperationsBtn');
      if (selectedOrderIds.length > 0) {
        batchBtn.removeAttribute('disabled');
        batchBtn.classList.remove('bg-purple-100', 'text-purple-600');
        batchBtn.classList.add('bg-purple-600', 'text-white');
      } else {
        batchBtn.setAttribute('disabled', 'disabled');
        batchBtn.classList.remove('bg-purple-600', 'text-white');
        batchBtn.classList.add('bg-purple-100', 'text-purple-600');
      }
    }
    
    // 显示批量操作模态框
    function showBatchOperationsModal() {
      if (selectedOrderIds.length === 0) return;
      
      document.getElementById('selectedOrdersCount').textContent = selectedOrderIds.length;
      document.getElementById('deleteOrdersCount').textContent = selectedOrderIds.length;
      document.getElementById('batchOperationsModal').classList.remove('hidden');
      
      // 重置表单
      document.getElementById('updateStatus').checked = false;
      document.getElementById('updateRepresentative').checked = false;
      document.getElementById('updateOperator').checked = false;
      
      document.getElementById('batchStatus').disabled = true;
      document.getElementById('batchRepresentative').disabled = true;
      document.getElementById('batchOperator').disabled = true;
      
      // 默认选择更新操作
      document.querySelector('input[name="operationType"][value="update"]').checked = true;
      toggleOperationType('update');
      
      // 添加复选框变化事件
      document.getElementById('updateStatus').addEventListener('change', function() {
        document.getElementById('batchStatus').disabled = !this.checked;
      });
      
      document.getElementById('updateRepresentative').addEventListener('change', function() {
        document.getElementById('batchRepresentative').disabled = !this.checked;
      });
      
      document.getElementById('updateOperator').addEventListener('change', function() {
        document.getElementById('batchOperator').disabled = !this.checked;
      });
      
      // 添加操作类型切换事件
      document.querySelectorAll('input[name="operationType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          toggleOperationType(this.value);
        });
      });
    }
    
    // 应用批量更新或删除
    function applyBatchOperations(e) {
        e.preventDefault();
        
        const operationType = document.querySelector('input[name="operationType"]:checked').value;
        
        if (operationType === 'update') {
            // 批量更新
            const updateStatus = document.getElementById('updateStatus').checked;
            const updateRepresentative = document.getElementById('updateRepresentative').checked;
            const updateOperator = document.getElementById('updateOperator').checked;
            
            if (!updateStatus && !updateRepresentative && !updateOperator) {
                alert('Por favor, selecione pelo menos um campo para atualizar.');
                return;
            }
            
            const newStatus = updateStatus ? document.getElementById('batchStatus').value : null;
            const newRepresentative = updateRepresentative ? document.getElementById('batchRepresentative').value : null;
            const newOperator = updateOperator ? document.getElementById('batchOperator').value : null;
            
            // 更新选中的订单
            selectedOrderIds.forEach(id => {
                const orderIndex = orders.findIndex(o => o.id === id);
                if (orderIndex !== -1) {
                    if (updateStatus) orders[orderIndex].status = newStatus;
                    if (updateRepresentative) orders[orderIndex].representative = newRepresentative;
                    if (updateOperator) orders[orderIndex].operator = newOperator;
                    orders[orderIndex].updatedAt = new Date().toISOString();
                }
            });
            
            showNotification('Pedidos atualizados com sucesso!', 'success');
        } else {
            // 批量删除 - 直接删除，不需要确认文本
            orders = orders.filter(order => !selectedOrderIds.includes(order.id));
            showNotification(`${selectedOrderIds.length} pedidos excluídos com sucesso!`, 'success');
        }
        
        // Salvar alterações
        saveToLocalStorage();
        
        // 重新应用过滤器和更新显示
        applyFilters();
        
        // 关闭模态框
        closeBatchOperationsModal();
        
        // 清除选择
        selectedOrderIds = [];
        document.getElementById('selectAllOrders').checked = false;
        updateBatchOperationsButton();
    }
    
    // 切换操作类型（更新/删除）
    function toggleOperationType(type) {
      if (type === 'update') {
        document.getElementById('updateFieldsSection').classList.remove('hidden');
        document.getElementById('deleteConfirmSection').classList.add('hidden');
        document.getElementById('batchSubmitBtn').textContent = 'Aplicar Alterações';
        document.getElementById('batchSubmitBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
        document.getElementById('batchSubmitBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');
      } else {
        document.getElementById('updateFieldsSection').classList.add('hidden');
        document.getElementById('deleteConfirmSection').classList.remove('hidden');
        document.getElementById('batchSubmitBtn').textContent = 'Excluir Pedidos';
        document.getElementById('batchSubmitBtn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
        document.getElementById('batchSubmitBtn').classList.add('bg-red-600', 'hover:bg-red-700');
      }
    }
    
    // 关闭批量操作模态框
    function closeBatchOperationsModal() {
      document.getElementById('batchOperationsModal').classList.add('hidden');
    }
    
    // 订单数据数组
    let orders = [];
    
    // 过滤后的订单数组
    let filteredOrders = [];
    
    // Supabase客户端
    let supabase = null;
    let isSupabaseInitialized = false;
    
    // 初始化Supabase
    async function initializeSupabase() {
      try {
        if (typeof window.SUPABASE_CONFIG === 'undefined') {
          console.warn('Supabase配置未找到，跳过云同步功能');
          return false;
        }
        
        supabase = window.supabase.createClient(
          window.SUPABASE_CONFIG.url,
          window.SUPABASE_CONFIG.anonKey
        );
        
        // 测试连接
        const { data, error } = await supabase
          .from(window.DB_CONFIG.tableName)
          .select('count', { count: 'exact', head: true });
        
        if (error) {
          console.error('Supabase连接测试失败:', error);
          return false;
        }
        
        isSupabaseInitialized = true;
        console.log('Supabase初始化成功');
        updateSyncStatus('已连接到云端', 'success');
        
        // 启动自动同步
        if (window.SYNC_CONFIG.autoSync) {
          startAutoSync();
        }
        
        return true;
      } catch (error) {
        console.error('Supabase初始化失败:', error);
        updateSyncStatus('云端连接失败', 'error');
        return false;
      }
    }
    
    // 同步数据到云端
    async function syncToCloud() {
      if (!isSupabaseInitialized) {
        console.warn('Supabase未初始化，无法同步到云端');
        return false;
      }
      
      updateSyncStatus('正在同步到云端...', 'syncing');
      
      try {
        // 首先获取云端所有数据的ID
        const { data: cloudData, error: selectError } = await supabase
          .from(window.DB_CONFIG.tableName)
          .select('id');
        
        if (selectError) {
          throw selectError;
        }
        
        // 获取本地数据的ID
        const localIds = orders.map(order => order.id);
        const cloudIds = cloudData ? cloudData.map(item => item.id) : [];
        
        // 找出需要删除的云端记录（存在于云端但不存在于本地）
        const idsToDelete = cloudIds.filter(id => !localIds.includes(id));
        
        // 删除云端中不存在于本地的记录
        if (idsToDelete.length > 0) {
          const { error: deleteError } = await supabase
            .from(window.DB_CONFIG.tableName)
            .delete()
            .in('id', idsToDelete);
          
          if (deleteError) {
            throw deleteError;
          }
          
          console.log(`已从云端删除 ${idsToDelete.length} 条记录:`, idsToDelete);
        }
        
        // 准备本地数据进行同步
        if (orders.length > 0) {
          const dataToSync = orders.map(order => ({
            id: order.id,
            nf: order.nf || null,
            pedido: order.pedido || null,
            tab_preco: order.tabPreco || null,
            acerto: parseFloat(order.acerto) || null,
            company: order.company || '',
            issue_date: order.issueDate || null,
            final_value: parseFloat(order.finalValue) || 0,
            order_type_description: order.orderTypeDescription || null,
            representative: order.representative || null,
            status: order.status || 'Aguardando',
            cx: order.cx || null,
            operator: order.operator || null,
            updated_at: new Date().toISOString()
          }));
          
          // 使用upsert来插入或更新数据
          const { data, error } = await supabase
            .from(window.DB_CONFIG.tableName)
            .upsert(dataToSync, { 
              onConflict: 'id',
              ignoreDuplicates: false 
            });
          
          if (error) {
            throw error;
          }
          
          console.log('数据同步到云端成功:', data);
        }
        
        updateSyncStatus('已同步到云端', 'success');
        localStorage.setItem('lastCloudSync', new Date().toISOString());
        return true;
        
      } catch (error) {
        console.error('同步到云端失败:', error);
        updateSyncStatus('同步失败', 'error');
        return false;
      }
    }
    
    // 从云端加载数据
    async function loadFromCloud() {
      if (!isSupabaseInitialized) {
        console.warn('Supabase未初始化，无法从云端加载数据');
        return false;
      }
      
      updateSyncStatus('正在从云端加载...', 'syncing');
      
      try {
        const { data, error } = await supabase
          .from(window.DB_CONFIG.tableName)
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        if (data && data.length > 0) {
          // 转换数据格式
          const cloudOrders = data.map(item => ({
            id: item.id,
            nf: item.nf,
            pedido: item.pedido,
            tabPreco: item.tab_preco,
            acerto: parseFloat(item.acerto) || null,
            company: item.company,
            issueDate: item.issue_date,
            finalValue: parseFloat(item.final_value) || 0,
            orderTypeDescription: item.order_type_description,
            representative: item.representative,
            status: item.status,
            cx: item.cx,
            operator: item.operator,
            createdAt: item.created_at,
            updatedAt: item.updated_at
          }));
          
          // 合并云端数据和本地数据
          const mergedOrders = mergeOrderData(orders, cloudOrders);
          orders = mergedOrders;
          
          // 保存到本地存储
          saveToLocalStorage();
          
          // 更新显示
          applyFilters();
          
          // 更新客户统计
          updateCustomerStatistics();
          
          console.log('从云端加载数据成功:', cloudOrders.length, '条记录');
          updateSyncStatus('已从云端加载', 'success');
          localStorage.setItem('lastCloudLoad', new Date().toISOString());
          return true;
        } else {
          console.log('云端暂无数据');
          updateSyncStatus('云端暂无数据', 'success');
          return true;
        }
        
      } catch (error) {
        console.error('从云端加载数据失败:', error);
        updateSyncStatus('加载失败', 'error');
        return false;
      }
    }
    
    // 合并订单数据（云端优先）
    function mergeOrderData(localOrders, cloudOrders) {
      const merged = [...cloudOrders];
      
      // 添加本地独有的数据
      localOrders.forEach(localOrder => {
        const existsInCloud = cloudOrders.find(cloudOrder => cloudOrder.id === localOrder.id);
        if (!existsInCloud) {
          merged.push(localOrder);
        }
      });
      
      return merged;
    }
    
    // 启动自动同步
    function startAutoSync() {
      if (window.SYNC_CONFIG.autoSync && window.SYNC_CONFIG.syncInterval > 0) {
        setInterval(async () => {
          if (isSupabaseInitialized) {
            await syncToCloud();
          }
        }, window.SYNC_CONFIG.syncInterval);
        
        console.log('自动同步已启动，间隔:', window.SYNC_CONFIG.syncInterval, 'ms');
      }
    }
    
    // 初始化搜索功能
    function initializeSearch() {
      const searchInput = document.getElementById('headerSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          applyFilters();
        });
      }
    }
    
    // 在DOM加载完成后初始化搜索
    document.addEventListener('DOMContentLoaded', function() {
      initializeSearch();
    });

    // 初始化搜索功能
    function initializeSearch() {
      const searchInput = document.getElementById('headerSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          applyFilters();
        });
      }
    }

    // 在DOM加载完成后初始化搜索
    document.addEventListener('DOMContentLoaded', function() {
      initializeSearch();
    });
    
    // 当前选中的状态过滤器
    let currentStatusFilter = 'all';
    
    // 当前打开的状态下拉菜单ID
    let currentOpenStatusDropdown = null;
    
    // 状态映射
    const statusMap = {
      'Aguardando': { class: 'bg-orange-100 text-orange-800', icon: 'fa-clock-o' },
      'Processando': { class: 'bg-blue-100 text-blue-800', icon: 'fa-spinner' },
      'Concluído': { class: 'bg-green-100 text-green-800', icon: 'fa-check-circle' },
      'Cancelado': { class: 'bg-red-100 text-red-800', icon: 'fa-times-circle' }
    };
    
    // 根据状态过滤订单
    function filterByStatus(status) {
        currentStatusFilter = status;
        
        // 更新桌面版导航栏样式 - 移除所有active类（桌面版导航在.hidden.md:block的nav中）
        document.querySelectorAll('nav.hidden.md\\:block .mobile-nav-item').forEach(item => {
            item.classList.remove('active');
            item.classList.add('text-gray-600');
        });
        
        // 更新移动端导航栏样式 - 移除所有active类
        document.querySelectorAll('#mobileNav .mobile-nav-item').forEach(item => {
            item.classList.remove('active');
            item.classList.add('text-gray-600');
        });
        
        // 激活当前选中的导航项（桌面版）
        const activeNav = document.getElementById(`nav-${status}`);
        if (activeNav) {
            activeNav.classList.remove('text-gray-600');
            activeNav.classList.add('active');
        }
        
        // 激活当前选中的导航项（移动端）
        const activeMobileNav = document.getElementById(`nav-${status}-mobile`);
        if (activeMobileNav) {
            activeMobileNav.classList.remove('text-gray-600');
            activeMobileNav.classList.add('active');
        }
        
        // 应用过滤器
        applyFilters();
        
        // 同步客户卡片状态
        syncCustomerCardWithFilter(status);
    }
    
    // 同步客户卡片与筛选状态
    function syncCustomerCardWithFilter(status) {
        // 状态映射：导航栏状态 -> 客户卡片状态
        const statusMapping = {
            'all': 'all',
            'pending': 'Aguardando',
            'processing': 'Processando', 
            'completed': 'Concluído',
            'cancelled': 'Cancelado'
        };
        
        const mappedStatus = statusMapping[status] || status;
        
        // 找到对应的状态索引
        const statusIndex = customerStatusCycle.findIndex(s => s.key === mappedStatus);
        if (statusIndex !== -1) {
            currentCustomerStatusIndex = statusIndex;
            const currentStatus = customerStatusCycle[currentCustomerStatusIndex];
            updateCustomerCardDisplay(currentStatus);
            
            // 更新客户统计
            updateCustomerStatistics();
        }
    }
    
    // 应用所有过滤器（状态 + 搜索 + 列筛选）
    function applyFilters() {
        // 直接调用列筛选功能，它会处理所有筛选逻辑
        applyColumnFilters();
        // 更新客户列表
        if (typeof renderCustomerList === 'function') {
            renderCustomerList();
        }
    }
    
    // 更新侧边栏计数
    function updateSidebarCounts() {
        const counts = {
            all: orders.length,
            pending: orders.filter(o => ['aguardando', 'pendente'].includes(o.status.toLowerCase())).length,
            processing: orders.filter(o => ['processando', 'em andamento'].includes(o.status.toLowerCase())).length,
            completed: orders.filter(o => ['concluído', 'finalizado'].includes(o.status.toLowerCase())).length,
            cancelled: orders.filter(o => o.status.toLowerCase() === 'cancelado').length
        };
        
        Object.keys(counts).forEach(status => {
            // 更新桌面版计数
            const countElement = document.getElementById(`count-${status}`);
            if (countElement) {
                countElement.textContent = counts[status];
            }
            
            // 更新移动端计数
            const mobileCountElement = document.getElementById(`count-${status}-mobile`);
            if (mobileCountElement) {
                mobileCountElement.textContent = counts[status];
            }
        });
    }
    
    // 搜索订单函数 - 简化为只调用 applyFilters
    function searchOrders() {
        applyFilters();
    }
    
    // 渲染过滤后的订单
    function renderFilteredOrders() {
        const tableBody = document.getElementById('orderTableBody');
        
        if (filteredOrders.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="14" class="px-6 py-8 text-center text-gray-400">
                        <i class="fa fa-search text-4xl mb-4 block"></i>
                        <p class="text-lg font-medium mb-2">Nenhum pedido encontrado</p>
                        <p class="text-sm">Tente ajustar os filtros de pesquisa</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        // 添加格式化客户名称的函数
        function formatCompanyName(companyName) {
            if (!companyName) return '';
            
            // 检查是否包含 " - " 分隔符
            const separatorIndex = companyName.indexOf(' - ');
            let name = companyName;
            if (separatorIndex !== -1) {
                // 获取分隔符后面的部分
                name = companyName.substring(separatorIndex + 3).trim();
            }
            
            // 将名称分成单词数组
            const words = name.split(' ');
            
            // 根据单词数量分成3行
            if (words.length <= 3) {
                // 如果单词数量少于等于3，每行一个单词
                return words.map(word => `<div>${word}</div>`).join('');
            } else {
                // 如果单词数量多于3，尽量平均分配
                const wordsPerLine = Math.ceil(words.length / 3);
                const line1 = words.slice(0, wordsPerLine).join(' ');
                const line2 = words.slice(wordsPerLine, wordsPerLine * 2).join(' ');
                const line3 = words.slice(wordsPerLine * 2).join(' ');
                
                return `<div>${line1}</div><div>${line2}</div><div>${line3}</div>`;
            }
        }
        
        // 修改渲染函数中的客户显示部分
        tableBody.innerHTML = filteredOrders.map((order, index) => {
            const statusInfo = statusMap[order.status] || { class: 'bg-gray-100 text-gray-800', icon: 'fa-question' };
            
            return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-4 text-center" data-column="checkbox">
                        <input type="checkbox" class="order-checkbox form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out" 
                               data-order-id="${order.id}" onchange="updateBatchOperationsButton()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-500 text-center" data-column="numero">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600 editable-cell" data-field="nf" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="nf">${formatValue(order.nf)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell" data-field="pedido" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="pedido">${formatPedido(order.pedido)}</td>
                    <td class="px-3 py-2 editable-cell" data-field="company" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="cliente">
                        <div class="text-sm font-medium text-gray-500">${formatCompanyName(order.company)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell" data-field="issueDate" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="data">${formatDate(order.issueDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-500 editable-cell" data-field="finalValue" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="valor">${formatCurrency(order.finalValue)}</td>

                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell" data-field="orderTypeDescription" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="tipo">${formatValue(order.orderTypeDescription)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell" data-field="representative" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="representante">${formatValue(order.representative)}</td>
                    <td class="px-6 py-4 whitespace-nowrap" data-column="status">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class} cursor-pointer hover:opacity-80" onclick="toggleStatusDropdown(${order.id}, event)">
                            <i class="fa ${statusInfo.icon} mr-1"></i>
                            ${formatValue(order.status)}
                        </span>
                        <div id="status-dropdown-${order.id}" class="hidden absolute z-10 mt-1 bg-white rounded-md shadow-lg py-1 text-sm">
                            <div class="px-2 py-1 text-xs text-gray-500 font-medium">Alterar status:</div>
                            <div class="status-option hover:bg-gray-100 px-3 py-1.5 cursor-pointer" onclick="updateOrderStatus(${order.id}, 'Aguardando')">Aguardando</div>
                            <div class="status-option hover:bg-gray-100 px-3 py-1.5 cursor-pointer" onclick="updateOrderStatus(${order.id}, 'Processando')">Processando</div>
                            <div class="status-option hover:bg-gray-100 px-3 py-1.5 cursor-pointer" onclick="updateOrderStatus(${order.id}, 'Concluído')">Concluído</div>
                            <div class="status-option hover:bg-gray-100 px-3 py-1.5 cursor-pointer" onclick="updateOrderStatus(${order.id}, 'Cancelado')">Cancelado</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell hidden md:table-cell" data-field="tabPreco" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="tabpreco">${formatTabPreco(order.tabPreco)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell hidden md:table-cell" data-field="acerto" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="acerto">${formatAcerto(order.acerto)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell hidden md:table-cell" data-field="cx" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="cx">${formatValue(order.cx)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 editable-cell hidden md:table-cell" data-field="operator" data-order-id="${order.id}" ondblclick="editCell(this)" data-column="operador">${formatValue(order.operator)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-column="acoes">
                        <div class="flex space-x-2">
                            <button onclick="editOrder(${order.id})" class="text-primary hover:text-primary/80 transition-colors">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button onclick="deleteOrder(${order.id})" class="text-red-500 hover:text-red-700 transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // 重新应用列显示状态
        applyColumnVisibility();
    }
    
    // 更新过滤后的统计信息
    function updateFilteredStatistics() {
        const total = filteredOrders.length;
        const pending = filteredOrders.filter(order => ['Aguardando', 'Pendente'].includes(order.status)).length;
        const completed = filteredOrders.filter(order => ['Concluído', 'Finalizado'].includes(order.status)).length;
        const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.finalValue, 0);
        
        document.getElementById('totalOrders').textContent = total;
        document.getElementById('pendingOrders').textContent = pending;
        document.getElementById('completedOrders').textContent = completed;
        document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
        
        // 更新客户数量统计
        updateCustomerStatistics();
    }
    
    // 客户状态循环数组
    const customerStatusCycle = [
        { key: 'all', label: 'Todos os Clientes', color: '#6b7280', icon: 'fa-users', iconColor: 'text-purple-600' },
        { key: 'Aguardando', label: 'Clientes Aguardando', color: '#ea580c', icon: 'fa-clock-o', iconColor: 'text-orange-600' },
        { key: 'Processando', label: 'Clientes Processando', color: '#2563eb', icon: 'fa-cog', iconColor: 'text-blue-600' },
        { key: 'Concluído', label: 'Clientes Concluídos', color: '#16a34a', icon: 'fa-check-circle', iconColor: 'text-green-600' },
        { key: 'Cancelado', label: 'Clientes Cancelados', color: '#dc2626', icon: 'fa-times-circle', iconColor: 'text-red-600' }
    ];
    
    let currentCustomerStatusIndex = 0;
    
    // 循环切换客户状态

    // 更新客户卡片显示
    function updateCustomerCardDisplay(statusConfig) {
        const labelElement = document.getElementById('customerStatusLabel');
        const countElement = document.getElementById('customerCount');
        const iconElement = document.getElementById('customerStatusIcon');
        
        if (labelElement) labelElement.textContent = statusConfig.label;
        if (countElement) countElement.style.color = statusConfig.color;
        if (iconElement) {
            iconElement.innerHTML = `<i class="fa ${statusConfig.icon} text-sm sm:text-xl ${statusConfig.iconColor}"></i>`;
        }
    }
    
    // 更新客户数量统计
    function updateCustomerStatistics() {
        // 获取唯一客户列表
        const uniqueCustomers = new Set();
        const customersByStatus = {
            'all': new Set(),
            'Aguardando': new Set(),
            'Processando': new Set(),
            'Concluído': new Set(),
            'Cancelado': new Set()
        };
        
        filteredOrders.forEach(order => {
            if (order.company && order.company.trim()) {
                uniqueCustomers.add(order.company);
                customersByStatus['all'].add(order.company);
                
                // 根据状态分类客户
                if (['Aguardando', 'Pendente'].includes(order.status)) {
                    customersByStatus['Aguardando'].add(order.company);
                } else if (order.status === 'Processando') {
                    customersByStatus['Processando'].add(order.company);
                } else if (['Concluído', 'Finalizado'].includes(order.status)) {
                    customersByStatus['Concluído'].add(order.company);
                } else if (order.status === 'Cancelado') {
                    customersByStatus['Cancelado'].add(order.company);
                }
            }
        });
        
        // 根据当前选中的状态更新显示
        const currentStatus = customerStatusCycle[currentCustomerStatusIndex];
        const currentCount = customersByStatus[currentStatus.key].size;
        
        // 更新客户数量
        document.getElementById('customerCount').textContent = currentCount;
        
        // 更新卡片显示样式
        updateCustomerCardDisplay(currentStatus);
    }
    
    // 格式化货币
    function formatCurrency(value) {
        if (value === undefined || value === null || isNaN(value)) {
            return '';
        }
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }
    

    
    // 格式化日期
    function formatDate(dateString) {
        if (!dateString || dateString === undefined) {
            return '';
        }
        
        // 如果是YYYY-MM-DD格式，直接解析避免时区问题
        if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateString.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            return date.toLocaleDateString('pt-BR');
        }
        
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR');
    }
    
    // 格式化日期用于筛选选项显示（DD/MM/YYYY格式）
    function formatDateForFilter(dateString) {
        if (!dateString || dateString === undefined) {
            return '';
        }
        
        let date;
        // 如果是YYYY-MM-DD格式，直接解析避免时区问题
        if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateString.split('-');
            date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        } else {
            date = new Date(dateString);
        }
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    // 格式化公司名称用于筛选选项显示（只显示"-"后面的内容）
    function formatCompanyNameForFilter(companyName) {
        if (!companyName || companyName === undefined) {
            return '';
        }
        // 检查是否包含 " - " 分隔符
        const separatorIndex = companyName.indexOf(' - ');
        if (separatorIndex !== -1) {
            // 返回分隔符后面的部分
            return companyName.substring(separatorIndex + 3).trim();
        }
        // 如果没有分隔符，返回原始名称
        return companyName;
    }
    
    // 格式化公司名称
    function formatCompanyName(company) {
        if (!company || company === undefined) {
            return '';
        }
        // 检查是否包含 " - " 分隔符
        if (company.includes(' - ')) {
            return company.split(' - ')[1] || '';
        }
        return company;
    }
    
    // 通用格式化函数 - 处理 undefined 值
    function formatValue(value) {
        if (value === undefined || value === null) {
            return '';
        }
        return value;
    }
    
    // 格式化Pedido字段 - 移除前导零
    function formatPedido(value) {
        if (value === undefined || value === null) {
            return '';
        }
        // 将值转换为字符串并移除前导零
        const stringValue = String(value);
        // 使用parseInt然后转回字符串来移除前导零，但保持原始格式如果不是纯数字
        if (/^\d+$/.test(stringValue)) {
            return String(parseInt(stringValue, 10));
        }
        return stringValue;
    }
    
    // 格式化Tab. Preço字段 - 显示横杠后面的内容
    function formatTabPreco(value) {
        if (value === undefined || value === null || value === '') {
            return '';
        }
        const stringValue = String(value);
        // 查找横杠的位置
        const dashIndex = stringValue.indexOf('-');
        if (dashIndex !== -1 && dashIndex < stringValue.length - 1) {
            // 返回横杠后面的内容
            return stringValue.substring(dashIndex + 1);
        }
        // 如果没有横杠，返回原值
        return stringValue;
    }
    
    // 格式化% Acerto字段 - 不显示0，显示负数，四舍五入不显示小数
    function formatAcerto(value) {
        if (value === undefined || value === null || value === '' || value === 0) {
            return '';
        }
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue === 0) {
            return '';
        }
        // 四舍五入到整数
        const roundedValue = Math.round(numValue);
        return roundedValue + '%';
    }
    
    // 显示添加订单模态框
    function showAddOrderModal() {
        document.getElementById('addOrderModal').classList.remove('hidden');
        document.getElementById('orderForm').reset();
    }
    
    // 关闭添加订单模态框
    function closeAddOrderModal() {
        document.getElementById('addOrderModal').classList.add('hidden');
    }
    
    // 显示导入模态框
    function showImportModal() {
        document.getElementById('importModal').classList.remove('hidden');
        initializeFileUpload(); // 初始化文件上传区域
    }
    
    // 关闭导入模态框
    function closeImportModal() {
        document.getElementById('importModal').classList.add('hidden');
        resetImportForm();
    }
    
    // 重置导入表单
    function resetImportForm() {
        document.getElementById('importFile').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileName').textContent = '';
        document.getElementById('fileSize').textContent = '';
    }
    
    // 初始化文件上传
    function initializeFileUpload() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('importFile');
        const selectFileBtn = document.getElementById('selectFileBtn');
        
        // 点击选择文件按钮时触发文件选择
        selectFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // 文件选择事件
        fileInput.addEventListener('change', handleFileSelect);
        
        // 拖拽事件
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('dragleave', handleDragLeave);
        dropArea.addEventListener('drop', handleFileDrop);
    }
    
    // 处理文件选择
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            validateAndSetFile(file);
        }
    }
    
    // 处理拖拽悬停
    function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('border-gray-400');
    }
    
    // 处理拖拽离开
    function handleDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('border-gray-400');
    }
    
    // 处理文件拖放
    function handleFileDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('border-gray-400');
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
            validateAndSetFile(files[0]);
        }
    }
    
    // 验证并设置文件
    function validateAndSetFile(file) {
        // 检查文件类型
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.json') && !fileName.endsWith('.csv') && 
            !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            alert('请选择支持的文件格式 (JSON, CSV, Excel)');
            return;
        }
        
        // 显示文件信息
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
        document.getElementById('fileInfo').classList.remove('hidden');
        
        // 设置文件到文件输入框
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('importFile').files = dataTransfer.files;
    }
    
    // 编辑订单
    function editOrder(id) {
        const order = orders.find(o => o.id === id);
        if (order) {
            document.getElementById('editOrderId').value = order.id;
            document.getElementById('editNf').value = order.nf || '';
            document.getElementById('editCompany').value = order.company || '';
            document.getElementById('editIssueDate').value = order.issueDate || '';
            document.getElementById('editFinalValue').value = order.finalValue || '';
            document.getElementById('editOrderTypeDescription').value = order.orderTypeDescription || '';
            document.getElementById('editRepresentative').value = order.representative || '';
            document.getElementById('editStatus').value = order.status || 'Pendente';
            document.getElementById('editCx').value = order.cx || '';
            document.getElementById('editOperator').value = order.operator || '';
            
            document.getElementById('editOrderModal').classList.remove('hidden');
        }
    }
    
    // 关闭编辑订单模态框
    function closeEditOrderModal() {
        document.getElementById('editOrderModal').classList.add('hidden');
    }
    
    // 删除订单
    function deleteOrder(id) {
        if (confirm('Tem certeza que deseja excluir este pedido?')) {
            orders = orders.filter(order => order.id !== id);
            saveToLocalStorage(); // Salvar automaticamente
            applyFilters();
        }
    }
    
    // 应用批量更新或删除
    function applyBatchOperations(e) {
        e.preventDefault();
        
        const operationType = document.querySelector('input[name="operationType"]:checked').value;
        
        if (operationType === 'update') {
            // 批量更新
            const updateStatus = document.getElementById('updateStatus').checked;
            const updateRepresentative = document.getElementById('updateRepresentative').checked;
            const updateOperator = document.getElementById('updateOperator').checked;
            
            if (!updateStatus && !updateRepresentative && !updateOperator) {
                alert('Por favor, selecione pelo menos um campo para atualizar.');
                return;
            }
            
            const newStatus = updateStatus ? document.getElementById('batchStatus').value : null;
            const newRepresentative = updateRepresentative ? document.getElementById('batchRepresentative').value : null;
            const newOperator = updateOperator ? document.getElementById('batchOperator').value : null;
            
            // 更新选中的订单
            selectedOrderIds.forEach(id => {
                const orderIndex = orders.findIndex(o => o.id === id);
                if (orderIndex !== -1) {
                    if (updateStatus) orders[orderIndex].status = newStatus;
                    if (updateRepresentative) orders[orderIndex].representative = newRepresentative;
                    if (updateOperator) orders[orderIndex].operator = newOperator;
                    orders[orderIndex].updatedAt = new Date().toISOString();
                }
            });
            
            showNotification('Pedidos atualizados com sucesso!', 'success');
        } else {
            // 批量删除 - 直接删除，不需要确认文本
            orders = orders.filter(order => !selectedOrderIds.includes(order.id));
            showNotification(`${selectedOrderIds.length} pedidos excluídos com sucesso!`, 'success');
        }
        
        // Salvar alterações
        saveToLocalStorage();
        
        // 重新应用过滤器和更新显示
        applyFilters();
        
        // 关闭模态框
        closeBatchOperationsModal();
        
        // 清除选择
        selectedOrderIds = [];
        document.getElementById('selectAllOrders').checked = false;
        updateBatchOperationsButton();
    }
    
    // Funções de persistência de dados

    // Carregar dados do localStorage
    function loadFromLocalStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          orders = JSON.parse(data);
          console.log('Dados carregados do armazenamento local com sucesso');
          
          // 更新客户统计
          updateCustomerStatistics();
        } else {
          console.log('Nenhum dado encontrado no armazenamento local, usando dados padrão');
        }
      } catch (error) {
        console.error('Falha ao carregar dados do armazenamento local:', error);
      }
    }

    // Salvar no localStorage e sincronizar com a nuvem
    async function saveToLocalStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
        console.log('Dados salvos no armazenamento local');
        
        // Tentar sincronizar com a nuvem se o Supabase estiver inicializado
        if (isSupabaseInitialized) {
          await syncToCloud();
        } else {
          updateSyncStatus('Salvo localmente', 'success');
        }
      } catch (error) {
        console.error('Falha ao salvar no armazenamento local:', error);
        updateSyncStatus('Falha ao salvar', 'error');
      }
    }

    // Sincronizar dados com o servidor
    async function syncWithServer() {
      updateSyncStatus('Sincronizando...', 'syncing');
      
      try {
        // Enviar dados locais para o servidor
        const response = await fetch(`${API_BASE_URL}/orders/sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            orders: orders,
            lastSync: localStorage.getItem('lastSync')
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // Atualizar dados locais
          if (result.orders) {
            orders = result.orders;
            saveToLocalStorage();
            applyFilters();
            updateFilteredStatistics();
          }
          
          localStorage.setItem('lastSync', new Date().toISOString());
          updateSyncStatus('Sincronizado', 'success');
        } else {
          throw new Error('Resposta do servidor com erro');
        }
      } catch (error) {
        console.error('Falha na sincronização:', error);
        updateSyncStatus('Falha na sincronização', 'error');
        
        // Se for um erro de rede, mostrar modo offline
        if (error.name === 'TypeError') {
          updateSyncStatus('Modo offline', 'offline');
        }
      }
    }

    // Atualizar indicador de status de sincronização
    function updateSyncStatus(message, type) {
      const statusElement = document.getElementById('syncStatus');
      if (!statusElement) return;
      
      const dot = statusElement.querySelector('div');
      const text = statusElement.querySelector('span');
      
      text.textContent = message;
      
      // Remover classes anteriores
      dot.className = 'w-2 h-2 rounded-full mr-2';
      
      // Adicionar classe baseada no tipo
      switch(type) {
        case 'success':
          dot.classList.add('bg-green-500');
          break;
        case 'error':
          dot.classList.add('bg-red-500');
          break;
        case 'syncing':
          dot.classList.add('bg-blue-500', 'animate-pulse');
          break;
        case 'offline':
          dot.classList.add('bg-gray-500');
          break;
        default:
          dot.classList.add('bg-gray-300');
      }
    }

    // Adicionar elemento de status de sincronização ao cabeçalho
    function addSyncStatusElement() {
      const headerRight = document.getElementById('headerRight');
      if (headerRight) {
        const syncContainer = document.createElement('div');
        syncContainer.className = 'flex items-center space-x-2';
        
        // Adicionar botão de sincronização manual
        const syncButton = document.createElement('button');
        syncButton.className = 'p-2 text-gray-500 hover:text-primary transition-colors rounded-lg hover:bg-gray-100';
        syncButton.innerHTML = '<i class="fa fa-refresh"></i>';
        syncButton.title = 'Sincronizar dados';
        syncButton.onclick = syncWithServer;
        
        const syncStatusElement = document.createElement('div');
        syncStatusElement.id = 'syncStatus';
        syncStatusElement.className = 'flex items-center text-sm';
        syncStatusElement.innerHTML = `
          <div class="w-2 h-2 rounded-full mr-2 bg-gray-300"></div>
          <span class="hidden sm:inline">Não sincronizado</span>
        `;
        
        syncContainer.appendChild(syncButton);
        syncContainer.appendChild(syncStatusElement);
        headerRight.appendChild(syncContainer);
      }
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', async function() {
        // 初始化Supabase
        await initializeSupabase();
        
        // 先从云端加载数据，如果失败则从本地加载
        const cloudLoadSuccess = await loadFromCloud();
        if (!cloudLoadSuccess) {
            // Carregar dados do armazenamento local
            loadFromLocalStorage();
        }
        
        // 初始化过滤器
        filterByStatus('all');
        
        // 更新客户统计
        updateCustomerStatistics();
        
        // Adicionar elemento de status de sincronização
        addSyncStatusElement();
        
        // 启动自动同步
        startAutoSync();
        
        // 初始化客户管理功能
        initializeCustomerManagement();
        
        // Configurar sincronização automática (a cada 5 minutos)
        setInterval(() => {
          if (navigator.onLine) {
            syncWithServer();
          }
        }, 5 * 60 * 1000);
        
        // Adicionar evento para sincronização quando voltar online
        window.addEventListener('online', () => {
          updateSyncStatus('Reconectado', 'success');
          syncWithServer();
        });
        
        window.addEventListener('offline', () => {
          updateSyncStatus('Offline', 'offline');
        });
        
        // 添加编辑表单提交事件监听
        document.getElementById('editOrderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const orderId = parseInt(document.getElementById('editOrderId').value);
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex !== -1) {
                const nfValue = document.getElementById('editNf').value;
                
                // 更新订单数据
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    nf: nfValue,
                    company: document.getElementById('editCompany').value,
                    issueDate: document.getElementById('editIssueDate').value,
                    finalValue: parseFloat(document.getElementById('editFinalValue').value),
                    orderTypeDescription: document.getElementById('editOrderTypeDescription').value,
                    representative: document.getElementById('editRepresentative').value,
                    status: document.getElementById('editStatus').value,
                    cx: document.getElementById('editCx').value,
                    operator: document.getElementById('editOperator').value,
                    updatedAt: new Date().toISOString()
                };
                
                // 如果NF字段有值，自动更新状态为"Concluído"
                if (nfValue && nfValue.trim() !== '') {
                    orders[orderIndex].status = 'Concluído';
                }
                
                // Salvar alterações
                saveToLocalStorage();
                
                // 重新应用过滤器和更新显示
                applyFilters();
                
                // 关闭模态框
                closeEditOrderModal();
                
                // 显示成功消息
                if (nfValue && nfValue.trim() !== '') {
                    showNotification('Pedido atualizado com sucesso! Status automaticamente alterado para Concluído.', 'success');
                } else {
                    showNotification('Pedido atualizado com sucesso!', 'success');
                }
            }
        });
        
        // 添加批量操作表单提交事件监听
        document.getElementById('batchOperationsForm').addEventListener('submit', applyBatchOperations);
    });
  // Evitar perda de dados ao atualizar a página
  window.addEventListener('beforeunload', function(e) {
    // Se houver alterações não sincronizadas, alertar o usuário
    if (orders.length > 0 && document.getElementById('syncStatus') && 
        document.getElementById('syncStatus').querySelector('span').textContent !== 'Sincronizado') {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // 列可见性控制函数
  function toggleColumnVisibilityModal() {
    const modal = document.getElementById('columnVisibilityModal');
    modal.classList.remove('hidden');
  }

  function closeColumnVisibilityModal() {
    const modal = document.getElementById('columnVisibilityModal');
    modal.classList.add('hidden');
    applyColumnVisibility();
  }

  function selectAllColumns() {
    const checkboxes = document.querySelectorAll('.column-toggle');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  function deselectAllColumns() {
    const checkboxes = document.querySelectorAll('.column-toggle');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  function applyColumnVisibility() {
    const checkboxes = document.querySelectorAll('.column-toggle');
    
    checkboxes.forEach(checkbox => {
      const columnName = checkbox.dataset.column;
      const isVisible = checkbox.checked;
      
      // 隐藏或显示表头
      const headerCells = document.querySelectorAll(`th[data-column="${columnName}"]`);
      headerCells.forEach(cell => {
        cell.style.display = isVisible ? '' : 'none';
      });
      
      // 隐藏或显示数据行中的对应列
      const dataCells = document.querySelectorAll(`td[data-column="${columnName}"]`);
      dataCells.forEach(cell => {
        cell.style.display = isVisible ? '' : 'none';
      });
    });
  }

  // 检查列是否可见的辅助函数
  function getVisibleColumn(columnName) {
    const checkbox = document.querySelector(`input[data-column="${columnName}"]`);
    return checkbox ? checkbox.checked : true; // 默认显示
  }

  // 页面加载时初始化列可见性
  document.addEventListener('DOMContentLoaded', function() {
    // 为复选框添加事件监听器
    const checkboxes = document.querySelectorAll('.column-toggle');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        // 实时应用列可见性变化
        applyColumnVisibility();
      });
    });
  });
  </script>

  <!-- 添加订单模态框 -->
  <div id="addOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Novo Pedido</h2>
            <button onclick="closeAddOrderModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="orderForm" class="space-y-4">
            <div>
              <label for="nf" class="block text-sm font-medium text-gray-700 mb-1">NF</label>
              <input type="text" id="nf" name="nf" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
              <input type="text" id="company" name="company" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="issueDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Emissão</label>
              <input type="date" id="issueDate" name="issueDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="finalValue" class="block text-sm font-medium text-gray-700 mb-1">Valor Final</label>
              <input type="number" id="finalValue" name="finalValue" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="orderTypeDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Tipo</label>
              <input type="text" id="orderTypeDescription" name="orderTypeDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="representative" class="block text-sm font-medium text-gray-700 mb-1">Representante</label>
              <input type="text" id="representative" name="representative" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="status" name="status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Pendente">Pendente</option>
                <option value="Em Processamento">Em Processamento</option>
                <option value="Enviado">Enviado</option>
                <option value="Entregue">Entregue</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </div>
            
            <div>
              <label for="cx" class="block text-sm font-medium text-gray-700 mb-1">CX</label>
              <input type="text" id="cx" name="cx" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="operator" class="block text-sm font-medium text-gray-700 mb-1">Operador</label>
              <input type="text" id="operator" name="operator" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeAddOrderModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                Cancelar
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                Adicionar Pedido
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑订单模态框 -->
  <div id="editOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Editar Pedido</h2>
            <button onclick="closeEditOrderModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="editOrderForm" class="space-y-4">
            <input type="hidden" id="editOrderId">
            
            <div>
              <label for="editNf" class="block text-sm font-medium text-gray-700 mb-1">NF</label>
              <input type="text" id="editNf" name="editNf" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editCompany" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
              <input type="text" id="editCompany" name="editCompany" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editIssueDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Emissão</label>
              <input type="date" id="editIssueDate" name="editIssueDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editFinalValue" class="block text-sm font-medium text-gray-700 mb-1">Valor Final</label>
              <input type="number" id="editFinalValue" name="editFinalValue" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editOrderTypeDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Tipo</label>
              <input type="text" id="editOrderTypeDescription" name="editOrderTypeDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editRepresentative" class="block text-sm font-medium text-gray-700 mb-1">Representante</label>
              <input type="text" id="editRepresentative" name="editRepresentative" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="editStatus" name="editStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Pendente">Pendente</option>
                <option value="Em Processamento">Em Processamento</option>
                <option value="Enviado">Enviado</option>
                <option value="Entregue">Entregue</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </div>
            
            <div>
              <label for="editCx" class="block text-sm font-medium text-gray-700 mb-1">CX</label>
              <input type="text" id="editCx" name="editCx" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label for="editOperator" class="block text-sm font-medium text-gray-700 mb-1">Operador</label>
              <input type="text" id="editOperator" name="editOperator" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeEditOrderModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                Cancelar
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                Salvar Alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 导入数据模态框 -->
  <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Importar Dados</h2>
            <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:border-gray-400 transition-colors cursor-pointer">
              <p class="text-gray-500 mb-2">Arraste arquivos Excel aqui ou clique para selecionar</p>
              <input type="file" id="importFile" accept=".json,.csv,.xlsx,.xls" class="hidden">
              <button type="button" id="selectFileBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                Selecionar arquivo
              </button>
              <div id="fileInfo" class="mt-3 hidden">
                <p class="text-sm text-gray-600">
                  Arquivo selecionado: <span id="fileName" class="font-medium"></span> <span id="fileSize" class="text-gray-500"></span>
                </p>
              </div>
            </div>
            
            <div class="text-sm text-gray-600">
              <p class="mb-2">Formatos suportados:</p>
              <ul class="list-disc list-inside space-y-1">
                <li>JSON: Array de objetos com as propriedades dos pedidos</li>
                <li>CSV: Primeira linha com cabeçalhos, dados separados por vírgula</li>
                <li>Excel: Primeira linha com cabeçalhos</li>
              </ul>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeImportModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                Cancelar
              </button>
              <button type="button" id="importBtn" onclick="processImport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                Importar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    // 处理表单提交
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const nfValue = document.getElementById('nf').value;
        
        // 获取表单数据
        const formData = {
            id: orders.length > 0 ? Math.max(...orders.map(o => o.id)) + 1 : 1,
            nf: nfValue,
            company: document.getElementById('company').value,
            issueDate: document.getElementById('issueDate').value,
            finalValue: parseFloat(document.getElementById('finalValue').value),
            orderTypeDescription: document.getElementById('orderTypeDescription').value,
            representative: document.getElementById('representative').value,
            status: document.getElementById('status').value,
            cx: document.getElementById('cx').value,
            operator: document.getElementById('operator').value,
            createdAt: new Date().toISOString()
        };
        
        // 如果NF字段有值，自动设置状态为"Concluído"
        if (nfValue && nfValue.trim() !== '') {
            formData.status = 'Concluído';
        }
        
        // 添加到订单数组
        orders.push(formData);
        
        // Salvar alterações
        saveToLocalStorage();
        
        // 重新应用过滤器和更新显示
        applyFilters();
        
        // 关闭模态框
        closeAddOrderModal();
        
        // 显示成功消息
        if (nfValue && nfValue.trim() !== '') {
            showNotification('Pedido adicionado com sucesso! Status automaticamente definido como Concluído.', 'success');
        } else {
            showNotification('Pedido adicionado com sucesso!', 'success');
        }
    });
    
    // 处理文件导入
    function processImport() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Selecionar arquivo！');
            return;
        }
        
        const fileName = file.name.toLowerCase();
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                let importedData = [];
                
                if (fileName.endsWith('.json')) {
                    // 处理JSON文件
                    importedData = JSON.parse(e.target.result);
                } else if (fileName.endsWith('.csv')) {
                    // 处理CSV文件
                    const csvData = e.target.result;
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = values[index] || '';
                            });
                            importedData.push(obj);
                        }
                    }
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // 处理Excel文件
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 设置转换选项，确保所有数据都作为字符串读取
                    const options = {
                        raw: false,  // 返回格式化的字符串
                        dateNF: 'dd/mm/yyyy'  // 设置日期格式
                    };
                    
                    importedData = XLSX.utils.sheet_to_json(worksheet, options);
                    
                    // 处理每行数据，确保Pedido字段正确提取
                    importedData = importedData.map(row => {
                        // 直接使用row.Pedido作为订单号
                        const pedido = row.Pedido || '';
                        
                        return {
                            ...row,
                            pedido: pedido
                        };
                    });
                }
                
                // 处理导入的数据
                if (importedData.length > 0) {
                    // 为导入的数据分配新的ID
                    const maxId = orders.length > 0 ? Math.max(...orders.map(o => o.id)) : 0;
                    importedData.forEach((item, index) => {
                        item.id = maxId + index + 1;
                        
                        // 处理日期格式
                        if (item['Data de Emissão'] || item.issueDate) {
                            const dateValue = item['Data de Emissão'] || item.issueDate;
                            if (dateValue instanceof Date) {
                                // Excel日期对象转换为YYYY-MM-DD格式
                                const year = dateValue.getFullYear();
                                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                                const day = String(dateValue.getDate()).padStart(2, '0');
                                item.issueDate = `${year}-${month}-${day}`;
                            } else if (typeof dateValue === 'string') {
                                // 处理字符串日期格式
                                item.issueDate = dateValue;
                            }
                        }
                        
                        // 确保数值字段是数字类型
                        if (item.finalValue || item['Valor Final']) {
                            item.finalValue = parseFloat(item.finalValue || item['Valor Final']) || 0;
                        }
                        
                        // 映射字段名称
                        // 处理订货号 (Pedido)
                        const rowValues = Object.values(item);
                        for (const value of rowValues) {
                            if (typeof value === 'string' && /^[0-9]{6,12}$/.test(value)) {
                                item.pedido = value;
                                break;
                            }
                        }
                        
                        // 支持不同大小写的NF字段识别
                        const nfKeys = Object.keys(item).filter(key => key.toLowerCase() === 'nf');
                        if (nfKeys.length > 0) {
                            item.nf = item[nfKeys[0]];
                        }
                        if (item['Cliente']) item.company = item['Cliente'];
                        if (item['Desc Tipo Pedido']) item.orderTypeDescription = item['Desc Tipo Pedido'];
                        if (item['Representante']) item.representative = item['Representante'];
                        if (item['CX']) item.cx = item['CX'];
                        if (item['Operador']) item.operator = item['Operador'];
                        
                        // 映射新添加的列
                        if (item['Tab. Preço']) item.tabPreco = item['Tab. Preço'];
                        if (item['% Acerto']) item.acerto = item['% Acerto'];

                        
                        // 设置默认状态
                        if (!item.status) {
                            item.status = 'Aguardando';
                        }
                        
                        // Adicionar data de importação
                        item.importedAt = new Date().toISOString();
                    });
                    
                    // 处理重复的Pedido号 - 如果存在相同Pedido号则覆盖
                    let updatedCount = 0;
                    let newCount = 0;
                    
                    importedData.forEach(newOrder => {
                        // 查找是否存在相同的Pedido号
                        const existingIndex = orders.findIndex(order => 
                            order.pedido && newOrder.pedido && 
                            order.pedido.toString() === newOrder.pedido.toString()
                        );
                        
                        if (existingIndex !== -1) {
                            // 如果找到重复的Pedido号，保留原有的ID并覆盖其他数据
                            const originalId = orders[existingIndex].id;
                            newOrder.id = originalId;
                            orders[existingIndex] = newOrder;
                            updatedCount++;
                        } else {
                            // 如果没有重复，直接添加到数组
                            orders.push(newOrder);
                            newCount++;
                        }
                    });
                    
                    // 调试：显示导入后的数据
                    console.log('=== IMPORTED DATA DEBUG ===');
                    console.log('Updated orders:', updatedCount, 'New orders:', newCount);
                    
                    // 显示最后几个订单的tabPreco字段
                    const lastOrders = orders.slice(-Math.min(5, orders.length));
                    lastOrders.forEach((order, index) => {
                        console.log(`Order ${order.id}:`, {
                            pedido: order.pedido,
                            tabPreco: order.tabPreco,
                            tabPrecoType: typeof order.tabPreco,
                            finalValue: order.finalValue
                        });
                    });
                    console.log('=== END DEBUG ===');
                    
                    // Salvar alterações
                    saveToLocalStorage();
                    
                    // 重新应用过滤器和更新显示
                    applyFilters();
                    
                    // 关闭模态框
                    closeImportModal();
                    
                    // 显示详细的导入统计信息
                    let message = '';
                    if (newCount > 0 && updatedCount > 0) {
                        message = `Importação concluída: ${newCount} novos pedidos adicionados, ${updatedCount} pedidos atualizados`;
                    } else if (newCount > 0) {
                        message = `${newCount} novos pedidos importados com sucesso!`;
                    } else if (updatedCount > 0) {
                        message = `${updatedCount} pedidos atualizados com sucesso!`;
                    } else {
                        message = 'Importação concluída, mas nenhum dado válido foi encontrado.';
                    }
                    showNotification(message, 'success');
                } else {
                    showNotification('Nenhum dado encontrado no arquivo.', 'error');
                }
            } catch (error) {
                console.error('Erro ao importar arquivo:', error);
                showNotification('Erro ao importar arquivo. Verifique o formato.', 'error');
            }
        };
        
        // 根据文件类型选择读取方式
        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            reader.readAsArrayBuffer(file);
        } else {
            reader.readAsText(file);
        }
    }
    
    // 打印订单列表函数
    function printOrderList() {
      // 创建一个新窗口用于打印
      const printWindow = window.open('', '_blank');
      
      // 获取当前过滤后的订单
      const ordersToPrint = filteredOrders.length > 0 ? filteredOrders : orders;
      
      // 创建打印页面的HTML内容
      let printContent = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
          <meta charset="UTF-8">
          <title>Lista de Pedidos</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { text-align: center; color: #165DFF; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            th, td { border: 1px solid #E5E6EB; padding: 8px; text-align: left; }
            th { background-color: #F5F7FA; font-weight: bold; color: #4E5969; }
            tr:nth-child(even) { background-color: #F9FAFB; }
            .print-info { text-align: right; font-size: 12px; color: #86909C; margin-bottom: 20px; }
            .status-aguardando { color: #FF7D00; }
            .status-processando { color: #165DFF; }
            .status-concluido { color: #00B42A; }
            .status-cancelado { color: #F53F3F; }
            .nf-column { color: #16a34a; font-weight: bold; }
          </style>
        </head>
        <body>
          <h1>Lista de Pedidos</h1>
          <div class="print-info">Data de impressão: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
          <table>
            <thead>
              <tr>
                ${getVisibleColumn('numero') ? '<th>Nº</th>' : ''}
                ${getVisibleColumn('nf') ? '<th>NF</th>' : ''}
                ${getVisibleColumn('pedido') ? '<th>Pedido</th>' : ''}
                ${getVisibleColumn('cliente') ? '<th>Cliente</th>' : ''}
                ${getVisibleColumn('data') ? '<th>DATA</th>' : ''}
                ${getVisibleColumn('valor') ? '<th>Valor Final</th>' : ''}
                ${getVisibleColumn('tipo') ? '<th>TIPO</th>' : ''}
                ${getVisibleColumn('representante') ? '<th>Representante</th>' : ''}
                ${getVisibleColumn('status') ? '<th>Status</th>' : ''}
                ${getVisibleColumn('tabpreco') ? '<th>Tab. Preço</th>' : ''}
                ${getVisibleColumn('acerto') ? '<th>% Acerto</th>' : ''}
                ${getVisibleColumn('cx') ? '<th>CX</th>' : ''}
                ${getVisibleColumn('operador') ? '<th>Operador</th>' : ''}
                <th>Modalidade</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // 添加订单数据行
      ordersToPrint.forEach((order, index) => {
        // 根据状态确定CSS类
        let statusClass = '';
        const status = order.status.toLowerCase();
        if (status.includes('aguardando') || status.includes('pendente')) {
          statusClass = 'status-aguardando';
        } else if (status.includes('processando') || status.includes('em andamento')) {
          statusClass = 'status-processando';
        } else if (status.includes('concluído') || status.includes('finalizado')) {
          statusClass = 'status-concluido';
        } else if (status.includes('cancelado')) {
          statusClass = 'status-cancelado';
        }
        
        // 格式化金额
        const formattedValue = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(order.finalValue || 0);
        
        // 添加行数据
        printContent += `
          <tr>
            ${getVisibleColumn('numero') ? `<td>${index + 1}</td>` : ''}
            ${getVisibleColumn('nf') ? `<td class="nf-column">${formatValue(order.nf)}</td>` : ''}
            ${getVisibleColumn('pedido') ? `<td>${formatPedido(order.pedido)}</td>` : ''}
            ${getVisibleColumn('cliente') ? `<td>${formatValue(order.company)}</td>` : ''}
            ${getVisibleColumn('data') ? `<td>${formatValue(order.issueDate)}</td>` : ''}
            ${getVisibleColumn('valor') ? `<td>${formattedValue}</td>` : ''}
            ${getVisibleColumn('tipo') ? `<td>${formatValue(order.orderTypeDescription)}</td>` : ''}
            ${getVisibleColumn('representante') ? `<td>${formatValue(order.representative)}</td>` : ''}
            ${getVisibleColumn('status') ? `<td class="${statusClass}">${formatValue(order.status)}</td>` : ''}
            ${getVisibleColumn('tabpreco') ? `<td>${formatTabPreco(order.tabPreco)}</td>` : ''}
            ${getVisibleColumn('acerto') ? `<td>${formatAcerto(order.acerto)}</td>` : ''}
            ${getVisibleColumn('cx') ? `<td>${formatValue(order.cx)}</td>` : ''}
            ${getVisibleColumn('operador') ? `<td>${formatValue(order.operator)}</td>` : ''}
            <td>${formatValue(order.deliveryMode)}</td>
          </tr>
        `;
      });
      
      // 完成HTML内容
      printContent += `
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      // 写入打印窗口并打印
      printWindow.document.open();
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      // 确保样式加载完成后打印
      printWindow.onload = function() {
        printWindow.print();
        // printWindow.close(); // 如果希望打印后自动关闭窗口，可以取消注释
      };
      
      // 在打印窗口中定义formatValue和formatPedido函数
      printWindow.formatValue = function(value) {
        return value !== undefined && value !== null ? value : '';
      };
      
      printWindow.formatPedido = function(value) {
        if (value === undefined || value === null) {
          return '';
        }
        // 将值转换为字符串并移除前导零
        const stringValue = String(value);
        // 使用parseInt然后转回字符串来移除前导零，但保持原始格式如果不是纯数字
        if (/^\d+$/.test(stringValue)) {
          return String(parseInt(stringValue, 10));
        }
        return stringValue;
      };
      
      printWindow.formatTabPreco = function(value) {
        if (value === undefined || value === null || value === '') {
          return '';
        }
        const stringValue = String(value);
        const dashIndex = stringValue.indexOf('-');
        if (dashIndex !== -1 && dashIndex < stringValue.length - 1) {
          return stringValue.substring(dashIndex + 1);
        }
        return stringValue;
      };
      
      printWindow.formatAcerto = function(value) {
        if (value === undefined || value === null || value === '' || value === 0) {
          return '';
        }
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue === 0) {
          return '';
        }
        const roundedValue = Math.round(numValue);
        return roundedValue + '%';
      };
    }
    
    // 辅助函数：格式化值（处理undefined或null）
    function formatValue(value) {
      return value !== undefined && value !== null ? value : '';
    }
    
    // 切换状态下拉菜单显示/隐藏
    function toggleStatusDropdown(orderId, event) {
        event.stopPropagation(); // 阻止事件冒泡
        
        const dropdownId = `status-dropdown-${orderId}`;
        const dropdown = document.getElementById(dropdownId);
        
        // 如果有其他打开的下拉菜单，先关闭它
        if (currentOpenStatusDropdown && currentOpenStatusDropdown !== dropdownId) {
            document.getElementById(currentOpenStatusDropdown).classList.add('hidden');
        }
        
        // 切换当前下拉菜单的显示状态
        if (dropdown.classList.contains('hidden')) {
            dropdown.classList.remove('hidden');
            currentOpenStatusDropdown = dropdownId;
            
            // 定位下拉菜单
            const rect = event.target.getBoundingClientRect();
            dropdown.style.top = `${rect.bottom + window.scrollY}px`;
            dropdown.style.left = `${rect.left + window.scrollX}px`;
        } else {
            dropdown.classList.add('hidden');
            currentOpenStatusDropdown = null;
        }
    }
    
    // 更新订单状态
    function updateOrderStatus(orderId, newStatus) {
        // 查找订单
        const orderIndex = orders.findIndex(order => order.id === orderId);
        if (orderIndex === -1) return;
        
        // 更新状态
        orders[orderIndex].status = newStatus;
        
        // 关闭下拉菜单
        const dropdown = document.getElementById(`status-dropdown-${orderId}`);
        if (dropdown) {
            dropdown.classList.add('hidden');
            currentOpenStatusDropdown = null;
        }
        
        // 重新应用过滤器和更新显示
        applyFilters();
        
        // 显示成功消息
        showNotification(`Status do pedido #${orderId} atualizado para ${newStatus}`, 'success');
    }
    
    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', function(event) {
        if (currentOpenStatusDropdown) {
            const dropdown = document.getElementById(currentOpenStatusDropdown);
            if (dropdown && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
                currentOpenStatusDropdown = null;
            }
        }
    });
    
    // 显示通知消息
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fa ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        
        // 3秒后自动消失
        setTimeout(() => {
            notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // 客户管理相关功能
    let customerSidebarVisible = true;
    let selectedCustomer = null;
    let customerData = {};

    // 切换客户侧边栏显示/隐藏
    function toggleCustomerSidebar() {
        const sidebar = document.getElementById('customerSidebar');
        const mainContent = document.getElementById('mainContent');
        const mainElement = document.querySelector('main');
        const isMobile = window.innerWidth <= 640; // 调整为640px
        const isTablet = window.innerWidth >= 641 && window.innerWidth <= 1366; // 平板范围641-1366px
        const isDesktop = window.innerWidth > 1366;
        
        customerSidebarVisible = !customerSidebarVisible;
        
        if (customerSidebarVisible) {
            // 显示客户侧边栏
            mainElement.classList.remove('sidebar-hidden');
            if (isMobile) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.position = 'fixed';
            } else if (isTablet) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.width = '280px';
                sidebar.style.opacity = '1';
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.position = 'relative';
                sidebar.style.display = 'block';
            } else if (isDesktop) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.width = '320px';
                sidebar.style.opacity = '1';
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.position = 'relative';
                sidebar.style.display = 'block';
            }
        } else {
            // 隐藏客户侧边栏，让表格扩展到全宽
            if (isMobile) {
                sidebar.classList.add('hidden-mobile');
                sidebar.style.transform = 'translateX(-100%)';
            } else {
                mainElement.classList.add('sidebar-hidden');
                sidebar.style.width = '0';
                sidebar.style.opacity = '0';
            }
        }
        
        updateToggleButton();
    }

    // 聚合客户数据
    function aggregateCustomerData() {
        customerData = {};
        
        // 使用filteredOrders而不是所有orders，这样客户数据会根据当前筛选状态更新
        filteredOrders.forEach(order => {
            const customerName = order.company || 'Cliente não informado';
            
            if (!customerData[customerName]) {
                customerData[customerName] = {
                    name: customerName,
                    totalOrders: 0,
                    totalValue: 0,
                    tabPrecoSet: new Set(),
                    totalAcerto: 0,
                    validAcertoCount: 0,
                    orders: []
                };
            }
            
            customerData[customerName].totalOrders++;
            customerData[customerName].totalValue += parseFloat(order.finalValue) || 0;
            
            // 收集Tab. Preço文字内容（去重）
            if (order.tabPreco && order.tabPreco !== null && order.tabPreco !== '') {
                const formattedTabPreco = formatTabPreco(order.tabPreco);
                if (formattedTabPreco) {
                    customerData[customerName].tabPrecoSet.add(formattedTabPreco);
                }
            }
            
            // 计算% Acerto汇总
            if (order.acerto && order.acerto !== null && order.acerto !== '') {
                const acertoValue = parseFloat(order.acerto);
                if (!isNaN(acertoValue)) {
                    customerData[customerName].totalAcerto += acertoValue;
                    customerData[customerName].validAcertoCount++;
                }
            }
            
            customerData[customerName].orders.push(order);
        });
        
        return customerData;
    }

    // 格式化客户名称，去掉前面的数字和横线
    function formatCustomerName(customerName) {
        if (!customerName) return '';
        
        // 检查是否包含 " - " 分隔符
        const separatorIndex = customerName.indexOf(' - ');
        if (separatorIndex !== -1) {
            // 获取分隔符后面的部分
            return customerName.substring(separatorIndex + 3).trim();
        }
        
        return customerName;
    }

    // 渲染客户列表
    function renderCustomerList() {
        const customerList = document.getElementById('customerList');
        const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
        
        aggregateCustomerData();
        
        // 按订单总金额排序
        const sortedCustomers = Object.values(customerData)
            .filter(customer => customer.name.toLowerCase().includes(searchTerm))
            .sort((a, b) => b.totalValue - a.totalValue);
        
        let html = '';
        
        if (sortedCustomers.length === 0) {
            html = '<div class="text-center text-gray-500 py-8">Nenhum cliente encontrado</div>';
        } else {
            sortedCustomers.forEach(customer => {
                const isSelected = selectedCustomer === customer.name;
                const displayName = formatCustomerName(customer.name);
                // 处理Tab. Preço文字内容和% Acerto平均值
                const tabPrecoText = customer.tabPrecoSet.size > 0 ? Array.from(customer.tabPrecoSet).join(', ') : '-';
                const avgAcerto = customer.validAcertoCount > 0 ? (customer.totalAcerto / customer.validAcertoCount) : 0;
                
                html += `
                    <div class="customer-item p-2 rounded-lg border transition-all duration-200 cursor-pointer ${
                        isSelected ? 'bg-white border-blue-300 shadow-md' : 'bg-white border-gray-200 hover:border-blue-200 hover:shadow-sm'
                    }" onclick="selectCustomer('${customer.name.replace(/'/g, "\\'")}')">  
                        <div class="text-center">
                            <div class="mb-2">
                                <h4 class="font-semibold text-gray-800 text-sm leading-tight" title="${customer.name}">
                                    ${displayName}
                                </h4>
                                <div class="mt-1 text-xs text-gray-600">
                                      <div class="flex justify-center items-center space-x-2">
                                          ${tabPrecoText && tabPrecoText !== '-' ? `<span class="font-medium" title="${tabPrecoText}">${tabPrecoText}</span>` : ''}
                                          ${formatAcerto(avgAcerto) ? `<span class="font-medium ml-2">${formatAcerto(avgAcerto)}</span>` : ''}
                                      </div>
                                  </div>
                            </div>
                            <div class="flex justify-center items-center space-x-3">
                                <div class="bg-white">
                                    <div class="text-red-700 font-bold text-base">R$ ${customer.totalValue.toFixed(2)}</div>
                                </div>
                                <div class="bg-white flex items-center space-x-1">
                                    <div class="text-blue-700 font-bold text-base">${customer.totalOrders}</div>
                                    <div class="text-blue-600 text-xs">${customer.totalOrders === 1 ? 'pedido' : 'pedidos'}</div>
                                </div>
                            </div>
                            ${isSelected ? '<div class="mt-1"><i class="fa fa-check-circle text-blue-600 text-sm"></i></div>' : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        customerList.innerHTML = html;
    }

    // 选择客户
    function selectCustomer(customerName) {
        if (selectedCustomer === customerName) {
            // 取消选择
            selectedCustomer = null;
            applyFilters(); // 显示所有订单
        } else {
            // 选择客户
            selectedCustomer = customerName;
            filterOrdersByCustomer(customerName);
        }
        
        renderCustomerList();
    }

    // 按客户过滤订单
    function filterOrdersByCustomer(customerName) {
        filteredOrders = orders.filter(order => 
            (order.company || 'Cliente não informado') === customerName
        );
        renderFilteredOrders();
        updateFilteredStatistics();
    }

    // 过滤客户列表
    function filterCustomers() {
        renderCustomerList();
    }

    // 初始化客户管理功能
    function initializeCustomerManagement() {
        renderCustomerList();
        
        // 检查屏幕尺寸并设置客户侧边栏的初始状态 - 参考云收账系统优化
        const isMobile = window.innerWidth <= 640; // 调整为640px
        const isTablet = window.innerWidth >= 641 && window.innerWidth <= 1366; // 平板范围641-1366px
        const isDesktop = window.innerWidth > 1366;
        const sidebar = document.getElementById('customerSidebar');
        const mainElement = document.querySelector('main');
        
        if (isMobile) {
            // 移动设备：默认隐藏
            customerSidebarVisible = false;
            sidebar.classList.add('hidden-mobile');
            sidebar.style.transform = 'translateX(-100%)';
            sidebar.style.position = 'fixed';
            mainElement.classList.remove('sidebar-hidden');
            updateToggleButton();
        } else if (isTablet) {
            // 平板设备：确保显示，使用grid布局
            customerSidebarVisible = true;
            sidebar.classList.remove('hidden-mobile');
            sidebar.style.width = '280px';
            sidebar.style.opacity = '1';
            sidebar.style.transform = 'translateX(0)';
            sidebar.style.position = 'relative';
            sidebar.style.display = 'block';
            mainElement.classList.remove('sidebar-hidden');
            updateToggleButton();
        } else if (isDesktop) {
            // 桌面设备：确保显示，使用grid布局
            customerSidebarVisible = true;
            sidebar.classList.remove('hidden-mobile');
            sidebar.style.width = '320px';
            sidebar.style.opacity = '1';
            sidebar.style.transform = 'translateX(0)';
            sidebar.style.position = 'relative';
            sidebar.style.display = 'block';
            mainElement.classList.remove('sidebar-hidden');
            updateToggleButton();
        }
    }
    
    function updateToggleButton() {
        const toggleBtn = document.getElementById('customerSidebarToggle');
        if (customerSidebarVisible) {
            toggleBtn.innerHTML = '<i class="fa fa-users mr-1 sm:mr-2"></i><span class="hidden sm:inline">Clientes</span><span class="sm:hidden">Clientes</span>';
            toggleBtn.classList.remove('bg-gray-100', 'text-gray-600');
            toggleBtn.classList.add('bg-blue-100', 'text-blue-600');
        } else {
            toggleBtn.innerHTML = '<i class="fa fa-users mr-1 sm:mr-2"></i><span class="hidden sm:inline">Mostrar Clientes</span><span class="sm:hidden">Mostrar</span>';
            toggleBtn.classList.remove('bg-blue-100', 'text-blue-600');
            toggleBtn.classList.add('bg-gray-100', 'text-gray-600');
        }
    }
    
    // 添加窗口大小变化监听器 - 参考云收账系统优化
    window.addEventListener('resize', function() {
        const sidebar = document.getElementById('customerSidebar');
        const mainElement = document.querySelector('main');
        const isMobile = window.innerWidth <= 640; // 调整为640px
        const isTablet = window.innerWidth >= 641 && window.innerWidth <= 1366; // 平板范围641-1366px
        const isDesktop = window.innerWidth > 1366;
        
        if (customerSidebarVisible) {
            mainElement.classList.remove('sidebar-hidden');
            if (isMobile) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.width = '';
                sidebar.style.opacity = '';
                sidebar.style.position = 'fixed';
            } else if (isTablet) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.width = '280px';
                sidebar.style.opacity = '1';
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.position = 'relative';
                sidebar.style.display = 'block';
            } else if (isDesktop) {
                sidebar.classList.remove('hidden-mobile');
                sidebar.style.width = '320px';
                sidebar.style.opacity = '1';
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.position = 'relative';
                sidebar.style.display = 'block';
            }
        } else {
            // 当侧边栏隐藏时，确保表格能扩展到全宽
            if (!isMobile) {
                mainElement.classList.add('sidebar-hidden');
            }
        }
    });

  // Evitar perda de dados ao atualizar a página
  window.addEventListener('beforeunload', function(e) {
    // Se houver alterações não sincronizadas, alertar o usuário
    if (orders.length > 0 && document.getElementById('syncStatus') && 
        document.getElementById('syncStatus').querySelector('span').textContent !== 'Sincronizado') {
      e.preventDefault();
      e.returnValue = '';
    }
  });
  </script>
  <!-- 批量操作模态框 -->
  <div id="batchOperationsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Operações em Lote</h2>
            <button onclick="closeBatchOperationsModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="batchOperationsForm" class="space-y-4">
            <div class="text-sm text-gray-500 mb-4">
              <span id="selectedOrdersCount">0</span> pedidos selecionados
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Operação</label>
              <div class="space-y-2">
                <div>
                  <label class="inline-flex items-center">
                    <input type="radio" name="operationType" value="update" class="form-radio h-4 w-4 text-blue-600" checked>
                    <span class="ml-2">Atualizar campos</span>
                  </label>
                </div>
                <div>
                  <label class="inline-flex items-center">
                    <input type="radio" name="operationType" value="delete" class="form-radio h-4 w-4 text-red-600">
                    <span class="ml-2 text-red-600 font-medium">Excluir pedidos</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div id="updateFieldsSection">
              <label class="block text-sm font-medium text-gray-700 mb-1">Campos para atualizar</label>
              <div class="space-y-2">
                <div>
                  <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" id="updateStatus">
                    <span class="ml-2">Status</span>
                  </label>
                  <select id="batchStatus" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <option value="Aguardando">Aguardando</option>
                    <option value="Processando">Processando</option>
                    <option value="Concluído">Concluído</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>
                
                <div>
                  <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" id="updateRepresentative">
                    <span class="ml-2">Representante</span>
                  </label>
                  <input type="text" id="batchRepresentative" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                </div>
                
                <div>
                  <label class="inline-flex items-center">
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" id="updateOperator">
                    <span class="ml-2">Operador</span>
                  </label>
                  <input type="text" id="batchOperator" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                </div>
              </div>
            </div>
            
            <div id="deleteConfirmSection" class="hidden">
              <div class="bg-red-50 border border-red-200 rounded-md p-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Atenção: Esta ação não pode ser desfeita</h3>
                    <div class="mt-2 text-sm text-red-700">
                      <p>Você está prestes a excluir <span id="deleteOrdersCount" class="font-bold">0</span> pedidos.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="closeBatchOperationsModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                Cancelar
              </button>
              <button type="submit" id="batchSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                Aplicar Alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 列可见性控制模态框 -->
  <div id="columnVisibilityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Controle de Colunas</h2>
            <button onclick="closeColumnVisibilityModal()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="space-y-3">
            <p class="text-sm text-gray-600 mb-4">Selecione as colunas que deseja exibir na tabela:</p>
            
            <div class="space-y-2 max-h-64 overflow-y-auto">
              <label class="flex items-center">
                <input type="checkbox" id="col-nf" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="nf" checked>
                <span class="ml-2 text-sm">NF</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-pedido" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="pedido" checked>
                <span class="ml-2 text-sm">Pedido</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-cliente" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="cliente" checked>
                <span class="ml-2 text-sm">Cliente</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-data" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="data" checked>
                <span class="ml-2 text-sm">DATA</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-valor" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="valor" checked>
                <span class="ml-2 text-sm">Valor Final</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-tipo" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="tipo" checked>
                <span class="ml-2 text-sm">TIPO</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-representante" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="representante" checked>
                <span class="ml-2 text-sm">Representante</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-status" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="status" checked>
                <span class="ml-2 text-sm">Status</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-tabpreco" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="tabpreco" checked>
                <span class="ml-2 text-sm">Tab. Preço</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-acerto" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="acerto" checked>
                <span class="ml-2 text-sm">% Acerto</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-cx" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="cx" checked>
                <span class="ml-2 text-sm">CX</span>
              </label>
              
              <label class="flex items-center">
                <input type="checkbox" id="col-operador" class="column-toggle form-checkbox h-4 w-4 text-blue-600" data-column="operador" checked>
                <span class="ml-2 text-sm">Operador</span>
              </label>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t">
              <div class="flex space-x-2">
                <button type="button" onclick="selectAllColumns()" class="px-3 py-1 text-xs bg-green-100 text-green-600 rounded hover:bg-green-200 transition-colors">
                  Selecionar Todas
                </button>
                <button type="button" onclick="deselectAllColumns()" class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors">
                  Desmarcar Todas
                </button>
              </div>
              
              <button type="button" onclick="closeColumnVisibilityModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                Aplicar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
